

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/StaticBlog/img/favicon.png">
  <link rel="icon" href="/StaticBlog/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="简简单单分析一个DICOM协议">
  <meta name="author" content="Zeyu Zhang">
  <meta name="keywords" content="">
  <meta name="description" content="简简单单分析一个DICOM协议">
<meta property="og:type" content="article">
<meta property="og:title" content="DICOM网络传输协议解析">
<meta property="og:url" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/index.html">
<meta property="og:site_name" content="A Random Blog">
<meta property="og:description" content="简简单单分析一个DICOM协议">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930193320612.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930193338568.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930194603984.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013183425277.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013183453881.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013183507932.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013231631533.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013231904790.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013195720471.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013234755122.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013195701896.png">
<meta property="article:published_time" content="2021-11-11T13:14:06.000Z">
<meta property="article:modified_time" content="2022-04-26T09:20:56.975Z">
<meta property="article:author" content="Zeyu Zhang">
<meta property="article:tag" content="DICOM">
<meta property="article:tag" content="Biomedical Engineering">
<meta property="article:tag" content="Biomedical Imaging">
<meta property="article:tag" content="Network">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930193320612.png">
  
  <title>DICOM网络传输协议解析 - A Random Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/StaticBlog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/StaticBlog/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/StaticBlog/assets/icon/iconfont/iconfont.css">
<link rel="stylesheet" href="/StaticBlog/css/layout.css">
<link rel="stylesheet" href="/StaticBlog/css/decoration.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"randomnamer.github.io","root":"/StaticBlog/","version":"1.8.12","typing":{"enable":true,"typeSpeed":40,"cursorChar":"|","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0,"position":"left"},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/StaticBlog/local-search.xml"};
  </script>
  <script  src="/StaticBlog/js/utils.js" ></script>
  <script  src="/StaticBlog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 50vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/StaticBlog/">
      <strong>RandomNamer&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/en/">
                <i class="iconfont icon-in-alt"></i>
                English
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class=" iconfont icon-search-alt" ></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/StaticBlog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="DICOM网络传输协议解析">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-11 21:14" pubdate>
        2021年11月11日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      27k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      85 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x post-page-container ">
    
      <div class="d-none d-lg-block col-lg-3 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
     
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">DICOM网络传输协议解析</h1>
            
             
            
             <p class="note-info"> 该页面有相关的 <span style="font-weight: 700;"><a target="_blank" rel="noopener" href="https://github.com/RandomNamer/BMECourseDesign " >个人项目</a></span> , 您在文章中看到的某些代码片段可能会在其中。 </p>
            
            <div class="markdown-body">
              <h2 align='center' style="font-family: serif; font-size: 40px;">DICOM网络传输协议解析</h2>

<blockquote>
<p>该博客是由本人<a target="_blank" rel="noopener" href="https://github.com/RandomNamer/BMECourseDesign">课程设计</a>其中一项报告改进而来。</p>
</blockquote>
<h2 id="一、概览"><a href="#一、概览" class="headerlink" title="一、概览"></a>一、概览</h2><h3 id="PACS简介"><a href="#PACS简介" class="headerlink" title="PACS简介"></a>PACS简介</h3><p>图像存档与通信系统（PACS）是一种医学成像技术，提供对多个模态图像的存储、访问、查找等功能。 PACS 图像存储和传输的通用格式是DICOM，而PACS本身就是DICOM标准的一部分。PACS系统由模态（Modality）、服务器（Server）和查看器（View Station）组成，可以认为是客户/服务模型的一种实现。其中模态和查看器都属于用户（Service Class User, SCU），而服务器被称作Service Class Provider，简写为SCP。</p>
<p>在实现上，模态通常是计算机断层扫描 (CT)、超声、核医学、正电子发射断层扫描 (PET) 和磁共振成像 (MRI)等数字成像设备。模态可以先发送到质量保证 (QA) 工作站，如果信息正确，则图像将传递到服务器中进行存储。这一步骤以来DICOM标准中的C-STORE协议。View Station是放射科医生审查患者研究并制定诊断的地方，其基本功能是对服务器中的数据执行增删改查操作，在DICOM标准中由C-FIND、C-MOVE 和 C-GET等实现。在View Station中，也可以继承报告系统等外围设施，并与医院内的其他信息系统如电子病历系统EMR相整合，形成端到端的工作流。</p>
<h4 id="DCMTK"><a href="#DCMTK" class="headerlink" title="DCMTK"></a>DCMTK</h4><p>这里我们采用了DCMTK工具包充当Modality和View Station。DCMTK是一套实现了DCM标准的开源程序包和库，使用C++开发，实现了跨平台。DCMTK中实现了大部分DICOM标准，包括图像的打开、转换和校验功能，以及在互联网上传输DICOM文件。</p>
<p>本次在macOS系统上构建DCMTK，在其它类UNIX系统下的构建应该也有着一致的步骤。DCMTK源码中已经写好了对应各种系统的<code>CMakelist</code>, 只需要执行<code>cmake</code>即可完成配置。然后在源文件路径下<code>make</code>即可构建整个项目，构建成功后会输出对应的静态库文件和二进制可执行文件：</p>
<img src="image-20210930193320612.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20210930193320612" style="zoom:33%;" />


<img src="image-20210930193338568.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20210930193338568" style="zoom:33%;" />


<p>输出有一组命令行工具和对应的静态链接库，满足了使用者通过系统命令调用和直接链接调用的需求，非常方便二次开发。同时，我们也可以直接使用生成的命令行工具执行各种DICOM操作，例如，我们可以用其中的<code>storescu</code>充当modality，向服务端发送DICOM文件。发送的格式为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">storescu [options] peer port dcmfile-in...<br></code></pre></td></tr></table></figure>

<h4 id="CONQEST-SERVER"><a href="#CONQEST-SERVER" class="headerlink" title="CONQEST SERVER"></a>CONQEST SERVER</h4><p>CONQUEST是一个轻量级的DICOM SERVER，实现了DIMSE消息机制，以及对多种数据库的支持。</p>
<h2 id="二、图像通信及其参数分析"><a href="#二、图像通信及其参数分析" class="headerlink" title="二、图像通信及其参数分析"></a>二、图像通信及其参数分析</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>DICOM是一种建构在TCP/IP之上的高层协议。DICOM协议的底层是ULP（Upper Layer Protocol）。它主要负责与TCP相对接，当 DICOM 应用实体通过 DIMSE 完成消息交换后，需要 DICOM 上层协议层 ULP 来提供传输支持。</p>
<p>ULP 提供 5 种连接控制服务：A-ASSOCIATE、A-RELEASE、A-ABORT、P-DATA、A-P-ABORT。</p>
<ul>
<li>A-ASSOCIATE： 用来在通信实体双方间协商并建立关联，交换一些初始化信息，因此它是一个证实性服务；</li>
<li>A-RELEASE： 用于在完成传输后释放关联，它是一个正常的中止方式，不会造成应用数据的丢失，也是一种证实性服务；</li>
<li>A-ABORT： 是当通信出现异常时用来终止关联，有可能造成一些暂存数据的丢失，它是一个非证实性服务；</li>
<li>P-DATA： 用来传输 DIMSE 命令流和数据流，通信实体一方一旦把 DIMSE 消息流传送出去就认定另一方能够准确无误地收到，因此它是一个非证实性服务；</li>
<li>A-P-ABORT： 也是用来终止关联，主要是用于当网络连接失败时，使得上层能够及时获得操作响应信息。</li>
</ul>
<p>ULP 提供了 7 个协议数据单元（Protocol Data Unit， PDU）来实现上述的 5 种服务 。</p>
<ul>
<li>A-ASSOCIATE-RQ： 建立ASSOCIATE请求</li>
<li>A-ASSOCIATE-AC： 接受ASSOCIATE建立</li>
<li>A-ASSOCIATE-RJ： 拒绝ASSOCIATE建立</li>
<li>P-DATA-TF： 进行数据传输</li>
<li>A-RELEASE-RQ： ASSOCIATE释放请求</li>
<li>A-RELEASE-RP： ASSOCIATE释放响应</li>
<li>A-ABORT： ASSOCIATE终止</li>
</ul>
<p>从前文也可以推测出DICOM图像传输的过程：通过Association PDU建立连接，通过P-DATA-TF PDU进行实际传输，传输完成后通过Release PDU进行连接释放，或在传输途中使用A-ABORT中止连接。</p>
<p>通信的细节将在下面进行讲述。</p>
<h3 id="C-STORE"><a href="#C-STORE" class="headerlink" title="C-STORE"></a>C-STORE</h3><p>这里使用<code>-v -d</code>参数使DCMTK的命令行工具输出Debug模式下的详尽日志，同时也可以使用网络抓包工具进行辅助分析。</p>
<img src="image-20210930194603984.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20210930194603984" style="zoom:50%;" />

<p>日志中包括双方建立连接，传输，传输完成的详细过程，其中包括建立连接时的请求和响应信息<code>A-ASSOCIATE-RQ</code>、<code>A-ASSOCIATE-AC</code>、发送store请求的DIMSE信息和收到store响应的DIMSE信息。</p>
<h4 id="连接建立"><a href="#连接建立" class="headerlink" title="连接建立"></a>连接建立</h4><p>在DICOM标准中，连接请求A-ASSOCIATE-RQ描述如下：</p>
<table>
<thead>
<tr>
<th align="center"><strong>PDU bytes</strong></th>
<th align="center"><strong>Field name</strong></th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">PDU-type</td>
<td align="center">01H</td>
</tr>
<tr>
<td align="center">02</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应为00H，但接收方不做校验。</td>
</tr>
<tr>
<td align="center">3-6</td>
<td align="center">PDU-length</td>
<td align="center">报文的长度。应该被编码为二进制数字。</td>
</tr>
<tr>
<td align="center">7-8</td>
<td align="center">Protocol-version</td>
<td align="center">用每一位代表一个DICOM UL协议。比如发送端支持协议版本1，就应该把第0位设置为1。</td>
</tr>
<tr>
<td align="center">9-10</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应为0000H，但接收方不做校验。</td>
</tr>
<tr>
<td align="center">11-26</td>
<td align="center">Called-AE-title</td>
<td align="center">接收端DICOM应用名称。应该被编码为16个字符，空字符用20H补齐。</td>
</tr>
<tr>
<td align="center">27-42</td>
<td align="center">Calling-AE-title</td>
<td align="center">发送端DICOM应用名称。应该被编码为16个字符，空字符用20H补齐。</td>
</tr>
<tr>
<td align="center">43-74</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应全为0，但接收方不做校验。</td>
</tr>
<tr>
<td align="center">75-xxx</td>
<td align="center">Variable items</td>
<td align="center">一个Application Context项目，多个Prensentation Context项目和用户信息。</td>
</tr>
</tbody></table>
<p>比如在例子中的传输中，就有一个PDU Length为 3853 + 6 bytes的请求报文，其发送端应用名为<code>STORESCU</code>，接收端AE title为<code>ANY-SCP</code>,  Application Context Name为<code>1.2.840.10008.3.1.1.1</code>。</p>
<p>在服务端收到请求后，服务器就会开始解析请求中携带的信息，主要是检查携带的Presentation Context，条件满足后就会做出响应，然后返回ASSOCIATE-AC报文，其结构定义如下：</p>
<table>
<thead>
<tr>
<th align="center"><strong>PDU bytes</strong></th>
<th align="center"><strong>Field name</strong></th>
<th align="center"><strong>Description of field</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">PDU-type</td>
<td align="center">02H</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应为00H，但接收方不做校验。</td>
</tr>
<tr>
<td align="center">3-6</td>
<td align="center">PDU-length</td>
<td align="center">报文的长度。应该被编码为二进制数字。</td>
</tr>
<tr>
<td align="center">7-8</td>
<td align="center">Protocol-version</td>
<td align="center">用每一位代表一个DICOM UL协议。比如发送端支持协议版本1，就应该把第0位设置为1。</td>
</tr>
<tr>
<td align="center">9-10</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应为0000H，但接收方不做校验。</td>
</tr>
<tr>
<td align="center">11-26</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应与 A-ASSOCIATE-RQ PDU一致, 但不做校验。</td>
</tr>
<tr>
<td align="center">27-42</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应与 A-ASSOCIATE-RQ PDU一致, 但不做校验。</td>
</tr>
<tr>
<td align="center">43-74</td>
<td align="center">Reserved</td>
<td align="center">保留字段，应与 A-ASSOCIATE-RQ PDU一致, 但不做校验。</td>
</tr>
<tr>
<td align="center">75-xxx</td>
<td align="center">Variable items</td>
<td align="center">一个Application Context项目，多个Prensentation Context项目和用户信息。</td>
</tr>
</tbody></table>
<h4 id="Presentation-Context"><a href="#Presentation-Context" class="headerlink" title="Presentation Context"></a>Presentation Context</h4><p>Presentation Context是DICOM协议中规定客户端支持传输形式的一种表示。它详细描述了该类型片段内容的结构和编码格式。它由3部分构成：一个Context ID, 一个Abstract Syntax和多个Transfer Syntax。</p>
<ol>
<li><strong>Context ID</strong>是一个1 - 255之间的正奇数</li>
<li><strong>Abstract Syntax</strong>是数据代表的含义，通常用DICOM SOP Class UID表示，如下面两种ID；同时也可以用私有ID表示来实现自定义图像类型的传输。<ul>
<li><code>1.2.840.10008.1.1</code>  <em>Verification SOP Class</em></li>
<li><code>1.2.840.10008.5.1.4.1.1</code>  <em>CT Image Storage</em></li>
</ul>
</li>
<li><strong>Transfer Syntax</strong>是数据编码格式。通常用DICOM Transfer Syntax Class UID表示，如下面两种ID；同时也可以用私有ID表示来实现自定义图像类型的传输。<ul>
<li><code>1.2.840.10008.1.2</code>  <em>Implicit VR Little Endian</em></li>
<li><code>1.2.840.10008.1.2.4.50</code>   <em>JPEG Baseline</em></li>
</ul>
</li>
</ol>
<p>dcmtk的日志可以帮助我们解析Presentation Context，如下所示：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>		 <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span><span class="hljs-operator">:</span>        <span class="hljs-number">45</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Proposed</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>     <span class="hljs-variable">Abstract</span> <span class="hljs-built_in">Syntax</span><span class="hljs-operator">:</span> <span class="hljs-operator">=</span><span class="hljs-variable">DigitalIntraOralXRayImageStorageForPresentation</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>     <span class="hljs-variable">Proposed</span> <span class="hljs-variable">SCP</span><span class="hljs-operator">/</span><span class="hljs-variable">SCU</span> <span class="hljs-variable">Role</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Default</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>     <span class="hljs-variable">Proposed</span> <span class="hljs-variable">Transfer</span> <span class="hljs-built_in">Syntax</span><span class="hljs-punctuation">(</span><span class="hljs-variable">es</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>       <span class="hljs-operator">=</span><span class="hljs-variable">LittleEndianExplicit</span><br></code></pre></td></tr></table></figure>

<p>在Server中，打开Debug模式日志，也会在对ASSOCIATE-RQ中携带的Presentation Context进行列印：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">45</span>: STARTED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">18</span>:<span class="hljs-number">25</span>:<span class="hljs-number">41</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] A-ASSOCIATE-RQ Packet Dump<br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Calling Application Title : <span class="hljs-string">&quot;STORESCU        &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Called Application Title : <span class="hljs-string">&quot;ANY-SCP         &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Application Context : <span class="hljs-string">&quot;1.2.840.10008.3.1.1.1&quot;</span>, PDU length: <span class="hljs-number">16384</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Number of Proposed Presentation Contexts: <span class="hljs-number">128</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">0</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.1.9.1.3&quot;</span> <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">1</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.1.9.1.3&quot;</span> <span class="hljs-number">1</span><br>...<br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">127</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.1.12.2&quot;</span> <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Server Command   := <span class="hljs-number">0001</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Message ID       := <span class="hljs-number">0001</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] FreeStore Left <span class="hljs-number">17269</span> <span class="hljs-keyword">on</span> c:\<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Written file: c:\users\admi\desktop\dicomserver150b\data\MF<span class="hljs-number">-0000012</span>\<span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span><span class="hljs-number">.5962</span><span class="hljs-number">.1</span><span class="hljs-number">.3</span><span class="hljs-number">.5012</span><span class="hljs-number">.1</span><span class="hljs-number">.1166546115</span><span class="hljs-number">.14677</span>_0001_000001_16341207560000.dcm<br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">45</span>: ENDED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">18</span>:<span class="hljs-number">25</span>:<span class="hljs-number">56</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">45</span>: TOTAL RUNNING TIME: <span class="hljs-number">15</span> SECONDS<br></code></pre></td></tr></table></figure>

<h4 id="DIMSE"><a href="#DIMSE" class="headerlink" title="DIMSE"></a>DIMSE</h4><p>DIMSE（DICOM Message Service Element）是在P-DATA PDU下传输的一种消息格式。DICOM3.0协议中共有11种DIMSE服务：</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Group</strong></th>
<th><strong>Type</strong></th>
</tr>
</thead>
<tbody><tr>
<td>C-STORE</td>
<td>DIMSE-C</td>
<td>operation</td>
</tr>
<tr>
<td>C-GET</td>
<td>DIMSE-C</td>
<td>operation</td>
</tr>
<tr>
<td>C-MOVE</td>
<td>DIMSE-C</td>
<td>operation</td>
</tr>
<tr>
<td>C-FIND</td>
<td>DIMSE-C</td>
<td>operation</td>
</tr>
<tr>
<td>C-ECHO</td>
<td>DIMSE-C</td>
<td>operation</td>
</tr>
<tr>
<td>N-EVENT-REPORT</td>
<td>DIMSE-N</td>
<td>notification</td>
</tr>
<tr>
<td>N-GET</td>
<td>DIMSE-N</td>
<td>operation</td>
</tr>
<tr>
<td>N-SET</td>
<td>DIMSE-N</td>
<td>operation</td>
</tr>
<tr>
<td>N-ACTION</td>
<td>DIMSE-N</td>
<td>operation</td>
</tr>
<tr>
<td>N-CREATE</td>
<td>DIMSE-N</td>
<td>operation</td>
</tr>
<tr>
<td>N-DELETE</td>
<td>DIMSE-N</td>
<td>operation</td>
</tr>
</tbody></table>
<p>这里还是以C-STORE为例进行分析。在收到服务端返回的ASSOCIATE-AC报文后，就正式发起store请求，进行传输。日志种会输出本次传输的DIMSE信息。</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">OUTGOING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">STORE</span> <span class="hljs-variable">RQ</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span>                    <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">SecondaryCaptureImageStorage</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Instance</span> <span class="hljs-variable">UID</span>     <span class="hljs-operator">:</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span><span class="hljs-number">.5962</span><span class="hljs-number">.99</span><span class="hljs-number">.1</span><span class="hljs-number">.2280943358</span><span class="hljs-number">.716200484</span><span class="hljs-number">.1363785608958</span><span class="hljs-number">.60</span><span class="hljs-number">.0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Priority</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">medium</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-variable">Store</span> <span class="hljs-variable">Response</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">STORE</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Presentation</span> <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span>       <span class="hljs-operator">:</span> <span class="hljs-number">203</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">SecondaryCaptureImageStorage</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Instance</span> <span class="hljs-variable">UID</span>     <span class="hljs-operator">:</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span><span class="hljs-number">.5962</span><span class="hljs-number">.99</span><span class="hljs-number">.1</span><span class="hljs-number">.2280943358</span><span class="hljs-number">.716200484</span><span class="hljs-number">.1363785608958</span><span class="hljs-number">.60</span><span class="hljs-number">.0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">none</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Success</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br></code></pre></td></tr></table></figure>

<p>在传输完成后，即可在服务端数据库看到这个图像，说明传输已经成功。</p>
<img src="image-20211013183425277.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013183425277" style="zoom:50%;" />

<h4 id="传输"><a href="#传输" class="headerlink" title="传输"></a>传输</h4><p>DIMSE传输与DICOM图像传输都是用P-DATA PDU，这里通过抓包软件对它们进行分析。</p>
<p>在A-ASSOCIATE AC消息之后，两者开始通过P-DATA PDU进行传输。首先我们可以看到C-STORE RQ这一DIMSE消息的报文。其信息内容与之前日志输出的完全一致。</p>
<img src="image-20211013183453881.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013183453881" style="zoom:50%;" />

<p>然后我们可以看到DCM文件被实际传输。PDV长度为32768B（32KB），实际上由24个长度为1514字节的TCP帧构成。传输的内容是小端序，未压缩，无加密。</p>
<img src="image-20211013183507932.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013183507932" style="zoom:50%;" />

<h3 id="C-FIND"><a href="#C-FIND" class="headerlink" title="C-FIND"></a>C-FIND</h3><h4 id="Information-Model"><a href="#Information-Model" class="headerlink" title="Information Model"></a>Information Model</h4><p>在DICOM标准中，查询/取回的信息模型有以下三种：</p>
<ul>
<li>Patient Root</li>
<li>Study Root</li>
<li>Patient/Study Only</li>
</ul>
<p>例如，在患者根模型中，有四种层级的分类：</p>
<ul>
<li>Patient：对应Patient Information Entity (IE)</li>
<li>Study：对应一个患者和Study IE</li>
<li>Series：Series依赖具体的modality，在一个study中。它对应着Series, Frame of Reference 和Equipment IE。</li>
<li>Composite Object Instance：对应Composite Object IE。</li>
</ul>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>C-FIND查询使用Key- Value进行，查询在SCP中会被转换为对应的SQL语句，向数据库发起查询。</p>
<table>
<thead>
<tr>
<th align="center"><strong>描述/模块</strong></th>
<th align="center"><strong>标签</strong></th>
<th align="center"><strong>匹配密钥类型</strong></th>
<th align="center"><strong>返回密钥类型</strong></th>
<th align="center"><strong>备注/匹配类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">病人姓名</td>
<td align="center">（0010,0010）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者ID</td>
<td align="center">（0010,0020）</td>
<td align="center">R</td>
<td align="center">1</td>
<td align="center">请求标识符中应显示。应使用单值匹配检索。注意由于预计只有一个响应，这是一个唯一的密钥。</td>
</tr>
<tr>
<td align="center">患者ID的发行人</td>
<td align="center">（0010,0021）</td>
<td align="center">R</td>
<td align="center">2</td>
<td align="center">应使用单值匹配检索。在有多个发行商的情况下，此密钥限制将患者ID（0010,0020）与患者ID（0010,0020）唯一域匹配。</td>
</tr>
<tr>
<td align="center">患者的出生日期</td>
<td align="center">（0010,0030）</td>
<td align="center">—</td>
<td align="center">2</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者的性别</td>
<td align="center">（0010,0040）</td>
<td align="center">—</td>
<td align="center">2</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者识别模块的所有其他属性</td>
<td align="center"></td>
<td align="center">—</td>
<td align="center">3</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者人口统计模块的所有其他属性</td>
<td align="center"></td>
<td align="center">—</td>
<td align="center">3</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">观察日期时间</td>
<td align="center">（0040，A032）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">值类型</td>
<td align="center">（0040，A040）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center">应与（0040，A043）的第一行相同</td>
</tr>
<tr>
<td align="center">概念名称代码序列</td>
<td align="center">（0040，A043）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center">请求中不应存在，响应中用应与标识符中内容模板序列（0040，A504）中标识的模板相同。</td>
</tr>
<tr>
<td align="center">&gt;代码值</td>
<td align="center">（0008,0100）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;编码方案指示</td>
<td align="center">（0008,0102）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;编码方案版本</td>
<td align="center">（0008,0103）</td>
<td align="center">—</td>
<td align="center">1C</td>
<td align="center">如果编码方案指示（0008,0102）的值不足以明确识别代码值（0008,0100），则为必填项。</td>
</tr>
<tr>
<td align="center">&gt;代码含义</td>
<td align="center">（0008,0104）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;概念名称代码序列的所有其他属性</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">内容序列</td>
<td align="center">（0040，A730）</td>
<td align="center">—</td>
<td align="center">2</td>
<td align="center">内容序列（0040，A730）是一个潜在的递归嵌套项目序列。内容序列应始终在请求标识符中发送零长度。响应数据集中的内容序列应包含所请求模板的内容项。</td>
</tr>
<tr>
<td align="center">&gt;内容序列的所有属性</td>
<td align="center"></td>
<td align="center">—</td>
<td align="center">—</td>
<td align="center">SCP提供的内容项目。对内容项属性类型的要求应符合SR文档内容模块中的定义。</td>
</tr>
<tr>
<td align="center">HL7结构化文档参考序列</td>
<td align="center">（0040，A390）</td>
<td align="center">—</td>
<td align="center">1C</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;参考的SOP类UID</td>
<td align="center">（0008,1150）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;引用的SOP实例UID</td>
<td align="center">（0008,1155）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;HL7实例标识符</td>
<td align="center">（0040，E001）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;检索URI</td>
<td align="center">（0040，E010）</td>
<td align="center">—</td>
<td align="center">3</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">包含其他参考实例序列的研究</td>
<td align="center">（0008,1200）</td>
<td align="center">—</td>
<td align="center">1C</td>
<td align="center">如果内容序列（0040，A390）包含引用使用患者/研究/系列/实例信息模型的SOP实例的内容项，则为必填项。</td>
</tr>
<tr>
<td align="center">&gt;引用系列序列</td>
<td align="center">（0008,1115）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;系列实例UID</td>
<td align="center">（0020,000E）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;引用实例序列</td>
<td align="center">（0008,114A）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;&gt;参考SOP类UID</td>
<td align="center">（0008,1150）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;&gt;引用的SOP实例UID</td>
<td align="center">（0008,1155）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h4><p>C-FIND也同样遵循上述的流程，即先通过Association PDU建立连接，通过P-DATA-TF PDU进行实际传输，传输完成后通过Release PDU进行连接释放。我们试验查询上一次写入的DCM文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ findscu -v -d -S -k &quot;(0008, 0052)=STUDY&quot; -k &quot;(0010,0020)=Case1&quot; 59.78.44.209 5678<br>D: $dcmtk: findscu v3.6.6 2021-01-14 $<br>D: <br>D: DcmDataDictionary: Loading file: /usr/local/Cellar/dcmtk/3.6.6/share/dcmtk/dicom.dic<br>D: Request Parameters:<br>D: ====================== BEGIN A-ASSOCIATE-RQ =====================<br>D: Our Implementation Class UID:      1.2.276.0.7230010.3.0.3.6.6<br>D: Our Implementation Version Name:   OFFIS_DCMTK_366<br>D: Their Implementation Class UID:    <br>D: Their Implementation Version Name: <br>D: Application Context Name:    1.2.840.10008.3.1.1.1<br>D: Calling Application Name:    FINDSCU<br>D: Called Application Name:     ANY-SCP<br>D: Responding Application Name: ANY-SCP<br>D: Our Max PDU Receive Size:    16384<br>D: Their Max PDU Receive Size:  0<br>D: Presentation Contexts:<br>D:   Context ID:        1 (Proposed)<br>D:     Abstract Syntax: =FINDStudyRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Proposed Transfer Syntax(es):<br>D:       =LittleEndianExplicit<br>D:       =BigEndianExplicit<br>D:       =LittleEndianImplicit<br>D: Requested Extended Negotiation: none<br>D: Accepted Extended Negotiation:  none<br>D: Requested User Identity Negotiation: none<br>D: User Identity Negotiation Response:  none<br>D: ======================= END A-ASSOCIATE-RQ ======================<br></code></pre></td></tr></table></figure>

<p>在ASSOCIATE-RQ中，我们可以看到它携带了一个Presentation Context，表示这个是一个StudyRoot的Information Model。对方只要支持这一种Infromation Model即可完成连接。</p>
<p>在DICOM 3.0中，C-FIND-RQ协议规定如下：</p>
<table>
<thead>
<tr>
<th align="center"><strong>Message Field</strong></th>
<th align="center"><strong>Description of Field</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">Command Group Length</td>
<td align="center">最后一个数值组到下一组的间隔</td>
</tr>
<tr>
<td align="center">Affected SOP Class UID</td>
<td align="center">本次操作的SOP Class UID</td>
</tr>
<tr>
<td align="center">Command Field</td>
<td align="center">0020H表示为C-FIND-RQ消息</td>
</tr>
<tr>
<td align="center">Message ID</td>
<td align="center">用来唯一表示本次操作并与其他正在进行的作业相区隔。</td>
</tr>
<tr>
<td align="center">Priority</td>
<td align="center">LOW = 0002H；MEDIUM = 0000H；HIGH = 0001H</td>
</tr>
<tr>
<td align="center">Command Data Set Type</td>
<td align="center">除0101H (Null)外均可.</td>
</tr>
<tr>
<td align="center">Identifier</td>
<td align="center">Service Class Specification数据集合，可以用来存储查询的Query。</td>
</tr>
</tbody></table>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span>: Requesting Association<br><span class="hljs-attribute">D</span>: setting network send timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: setting network receive timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: Constructing Associate RQ PDU<br><span class="hljs-attribute">D</span>: PDU Type: Associate Accept, PDU Length: <span class="hljs-number">187</span> + <span class="hljs-number">6</span> bytes PDU header<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">02</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  bb  <span class="hljs-number">00</span>  <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">41</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">59</span>  <span class="hljs-number">2</span>d  <span class="hljs-number">53</span>  <span class="hljs-number">43</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">50</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">46</span>  <span class="hljs-number">49</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">44</span>  <span class="hljs-number">53</span>  <span class="hljs-number">43</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">55</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">10</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">15</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">21</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">19</span>  <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">40</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">11</span>  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">50</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">3</span>d  <span class="hljs-number">51</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">04</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">80</span>  <span class="hljs-number">00</span>  <span class="hljs-number">52</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">22</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">32</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">36</span>  <span class="hljs-number">38</span>  <span class="hljs-number">30</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">30</span>  <span class="hljs-number">34</span>  <span class="hljs-number">33</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">33</span>  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">36</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">30</span>  <span class="hljs-number">31</span>  <span class="hljs-number">55</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">0</span>b  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>f  <span class="hljs-number">57</span>  <span class="hljs-number">49</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">33</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Parsing an A-ASSOCIATE PDU<br><span class="hljs-attribute">D</span>: Association Parameters Negotiated:<br><span class="hljs-attribute">D</span>: ====================== BEGIN A-ASSOCIATE-AC =====================<br><span class="hljs-attribute">D</span>: Our Implementation Class UID:      <span class="hljs-number">1.2.276.0</span>.<span class="hljs-number">7230010</span>.<span class="hljs-number">3.0.3.6</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">D</span>: Our Implementation Version Name:   OFFIS_DCMTK_<span class="hljs-number">366</span><br><span class="hljs-attribute">D</span>: Their Implementation Class UID:    <span class="hljs-number">1.2.826.0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3680043</span>.<span class="hljs-number">2</span>.<span class="hljs-number">135</span>.<span class="hljs-number">1066</span>.<span class="hljs-number">101</span><br><span class="hljs-attribute">D</span>: Their Implementation Version Name: <span class="hljs-number">1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/WIN<span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Application Context Name:    <span class="hljs-number">1.2.840.100</span><span class="hljs-number">08.3.1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Calling Application Name:    FINDSCU<br><span class="hljs-attribute">D</span>: Called Application Name:     ANY-SCP<br><span class="hljs-attribute">D</span>: Responding Application Name: ANY-SCP<br><span class="hljs-attribute">D</span>: Our Max PDU Receive Size:    <span class="hljs-number">16384</span><br><span class="hljs-attribute">D</span>: Their Max PDU Receive Size:  <span class="hljs-number">32768</span><br><span class="hljs-attribute">D</span>: Presentation Contexts:<br><span class="hljs-attribute">D</span>:   Context ID:        <span class="hljs-number">1</span> (Accepted)<br><span class="hljs-attribute">D</span>:     Abstract Syntax: =FINDStudyRootQueryRetrieveInformationModel<br><span class="hljs-attribute">D</span>:     Proposed SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted Transfer Syntax: =LittleEndianImplicit<br><span class="hljs-attribute">D</span>: Requested Extended Negotiation: none<br><span class="hljs-attribute">D</span>: Accepted Extended Negotiation:  none<br><span class="hljs-attribute">D</span>: Requested User Identity Negotiation: none<br><span class="hljs-attribute">D</span>: User Identity Negotiation Response:  none<br><span class="hljs-attribute">D</span>: ======================= END A-ASSOCIATE-AC ======================<br></code></pre></td></tr></table></figure>

<p>对方发会响应，连接建立。</p>
<p>然后就是在P-DATA层发送DIMSE消息。可以看到DIMSE消息中主要含有这次的SOP，也就是StudyRoot查询的Information Model，同时也携带着两个Query。</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Association</span> <span class="hljs-variable">Accepted</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">Max</span> <span class="hljs-variable">Send</span> <span class="hljs-variable">PDV</span><span class="hljs-operator">:</span> <span class="hljs-number">32756</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Sending</span> <span class="hljs-built_in">Find</span> <span class="hljs-variable">Request</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">OUTGOING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">FIND</span> <span class="hljs-variable">RQ</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Presentation</span> <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span>       <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span>                    <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">FINDStudyRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Priority</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">medium</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Request</span> <span class="hljs-variable">Identifiers</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Dicom</span><span class="hljs-operator">-</span><span class="hljs-variable">Data</span><span class="hljs-operator">-</span><span class="hljs-built_in">Set</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Used</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">:</span> <span class="hljs-variable">Little</span> <span class="hljs-variable">Endian</span> <span class="hljs-variable">Explicit</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0008</span><span class="hljs-operator">,</span><span class="hljs-number">0052</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">CS</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">STUDY</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">QueryRetrieveLevel</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0010</span><span class="hljs-operator">,</span><span class="hljs-number">0020</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">LO</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Case1</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">PatientID</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>在服务端，我们可以通过查看日志，确定查询的操作方式：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">46</span>: STARTED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">19</span>:<span class="hljs-number">36</span>:<span class="hljs-number">59</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] A-ASSOCIATE-RQ Packet Dump<br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Calling Application Title : <span class="hljs-string">&quot;FINDSCU         &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Called Application Title : <span class="hljs-string">&quot;ANY-SCP         &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Application Context : <span class="hljs-string">&quot;1.2.840.10008.3.1.1.1&quot;</span>, PDU length: <span class="hljs-number">16384</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Number of Proposed Presentation Contexts: <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">0</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.2.2.1&quot;</span> <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Server Command   := <span class="hljs-number">0020</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Message ID       := <span class="hljs-number">0001</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] (StudyRootQuery) search level: STUDY <br>[<span class="hljs-meta">CONQUESTSRV1</span>] Query On Study<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Issue Query <span class="hljs-keyword">on</span> Columns: DICOMStudies.PatientID<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Values: DICOMStudies.PatientID = <span class="hljs-string">&#x27;Case1&#x27;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Tables: DICOMStudies<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Sorting ((<span class="hljs-literal">null</span>)) DoSort := <span class="hljs-number">0</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Records = <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] C-Find (StudyRoot) located <span class="hljs-number">1</span> records<br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">46</span>: ENDED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">19</span>:<span class="hljs-number">36</span>:<span class="hljs-number">59</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">46</span>: TOTAL RUNNING TIME: <span class="hljs-number">0</span> SECONDS<br></code></pre></td></tr></table></figure>

<p>可以看到，服务端先是确定从Study为根结点开始查询，然后在刚才指定的PatientID列开始查询，找到了一条记录，然后发送响应，下面是SCU解析的响应内容：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-built_in">Find</span> <span class="hljs-variable">Response</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">FIND</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">FINDStudyRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">xff00</span><span class="hljs-operator">:</span> <span class="hljs-variable">Pending</span><span class="hljs-operator">:</span> <span class="hljs-variable">Matches</span> <span class="hljs-variable">are</span> <span class="hljs-variable">continuing</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Response</span> <span class="hljs-variable">Identifiers</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Dicom</span><span class="hljs-operator">-</span><span class="hljs-variable">Data</span><span class="hljs-operator">-</span><span class="hljs-built_in">Set</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Used</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">:</span> <span class="hljs-variable">Little</span> <span class="hljs-variable">Endian</span> <span class="hljs-variable">Implicit</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0008</span><span class="hljs-operator">,</span><span class="hljs-number">0052</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">CS</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">STUDY</span> <span class="hljs-punctuation">]</span>                                 <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">QueryRetrieveLevel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0010</span><span class="hljs-operator">,</span><span class="hljs-number">0020</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">LO</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Case1</span> <span class="hljs-punctuation">]</span>                                 <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">PatientID</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-variable">Final</span> <span class="hljs-built_in">Find</span> <span class="hljs-variable">Response</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">FIND</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">FINDStudyRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">none</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Success</span><span class="hljs-operator">:</span> <span class="hljs-variable">Matching</span> <span class="hljs-variable">is</span> <span class="hljs-variable">complete</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Releasing</span> <span class="hljs-built_in">Association</span><br></code></pre></td></tr></table></figure>

<h3 id="C-MOVE"><a href="#C-MOVE" class="headerlink" title="C-MOVE"></a>C-MOVE</h3><p>C-MOVE可以理解为在C-FIND查询之后，由C-MOVE的SCP向SCU发起C-STORE请求，最终将图像传输到C-MOVE的SCU上。</p>
<p>从抓包软件分析可以看出，SCU先是向SCP传输C-MOVE DIMSE， 对方收到之后又会反过来发送连接请求，连接成功后就会发宋C-STORE DIMSE，进行C-STORE传输。</p>
<img src="image-20211013231631533.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013231631533" style="zoom:50%;" />

<p>在C-STORE传输完成（PDU方发送C-STORE RSP）后，对方又会发来C-MOVE的响应，在所有子C-STORE操作完成后，会发送一个总的C-STORE响应，双方开始断开连接。</p>
<img src="image-20211013231904790.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013231904790" style="zoom:50%;" />

<h4 id="日志分析-1"><a href="#日志分析-1" class="headerlink" title="日志分析"></a>日志分析</h4><p>首先是SCU向SCP请求建立连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ movescu -v -d -aem &quot;DCMTK&quot; --port 7777 -k 0008,0052=STUDY -k 0010,0020=&quot;Case1&quot; 59.78.44.209 5678<br>D: DcmDataDictionary: Loading file: /usr/local/Cellar/dcmtk/3.6.6/share/dcmtk/dicom.dic<br>D: $dcmtk: movescu v3.6.6 2021-01-14 $<br>D: <br>D: Request Parameters:<br>D: ====================== BEGIN A-ASSOCIATE-RQ =====================<br>D: Our Implementation Class UID:      1.2.276.0.7230010.3.0.3.6.6<br>D: Our Implementation Version Name:   OFFIS_DCMTK_366<br>D: Their Implementation Class UID:    <br>D: Their Implementation Version Name: <br>D: Application Context Name:    1.2.840.10008.3.1.1.1<br>D: Calling Application Name:    MOVESCU<br>D: Called Application Name:     ANY-SCP<br>D: Responding Application Name: ANY-SCP<br>D: Our Max PDU Receive Size:    16384<br>D: Their Max PDU Receive Size:  0<br>D: Presentation Contexts:<br>D:   Context ID:        1 (Proposed)<br>D:     Abstract Syntax: =FINDPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Proposed Transfer Syntax(es):<br>D:       =LittleEndianExplicit<br>D:       =BigEndianExplicit<br>D:       =LittleEndianImplicit<br>D:   Context ID:        3 (Proposed)<br>D:     Abstract Syntax: =MOVEPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Proposed Transfer Syntax(es):<br>D:       =LittleEndianExplicit<br>D:       =BigEndianExplicit<br>D:       =LittleEndianImplicit<br>D: Requested Extended Negotiation: none<br>D: Accepted Extended Negotiation:  none<br>D: Requested User Identity Negotiation: none<br>D: User Identity Negotiation Response:  none<br>D: ======================= END A-ASSOCIATE-RQ ======================<br>I: Requesting Association<br>D: setting network send timeout to 60 seconds<br>D: setting network receive timeout to 60 seconds<br>D: Constructing Associate RQ PDU<br>D: PDU Type: Associate Accept, PDU Length: 216 + 6 bytes PDU header<br>D:   02  00  00  00  00  d8  00  01  00  00  41  4e  59  2d  53  43<br>D:   50  20  20  20  20  20  20  20  20  20  4d  4f  56  45  53  43<br>D:   55  20  20  20  20  20  20  20  20  20  00  00  00  00  00  00<br>D:   00  00  00  00  00  00  00  00  00  00  00  00  00  00  00  00<br>D:   00  00  00  00  00  00  00  00  00  00  10  00  00  15  31  2e<br>D:   32  2e  38  34  30  2e  31  30  30  30  38  2e  33  2e  31  2e<br>D:   31  2e  31  21  00  00  19  01  00  00  00  40  00  00  11  31<br>D:   2e  32  2e  38  34  30  2e  31  30  30  30  38  2e  31  2e  32<br>D:   21  00  00  19  03  00  00  00  40  00  00  11  31  2e  32  2e<br>D:   38  34  30  2e  31  30  30  30  38  2e  31  2e  32  50  00  00<br>D:   3d  51  00  00  04  00  00  80  00  52  00  00  22  31  2e  32<br>D:   2e  38  32  36  2e  30  2e  31  2e  33  36  38  30  30  34  33<br>D:   2e  32  2e  31  33  35  2e  31  30  36  36  2e  31  30  31  55<br>D:   00  00  0b  31  2e  35  2e  30  2f  57  49  4e  33  32<br>D: Parsing an A-ASSOCIATE PDU<br>D: Association Parameters Negotiated:<br>D: ====================== BEGIN A-ASSOCIATE-AC =====================<br>D: Our Implementation Class UID:      1.2.276.0.7230010.3.0.3.6.6<br>D: Our Implementation Version Name:   OFFIS_DCMTK_366<br>D: Their Implementation Class UID:    1.2.826.0.1.3680043.2.135.1066.101<br>D: Their Implementation Version Name: 1.5.0/WIN32<br>D: Application Context Name:    1.2.840.10008.3.1.1.1<br>D: Calling Application Name:    MOVESCU<br>D: Called Application Name:     ANY-SCP<br>D: Responding Application Name: ANY-SCP<br>D: Our Max PDU Receive Size:    16384<br>D: Their Max PDU Receive Size:  32768<br>D: Presentation Contexts:<br>D:   Context ID:        1 (Accepted)<br>D:     Abstract Syntax: =FINDPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Accepted SCP/SCU Role: Default<br>D:     Accepted Transfer Syntax: =LittleEndianImplicit<br>D:   Context ID:        3 (Accepted)<br>D:     Abstract Syntax: =MOVEPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Accepted SCP/SCU Role: Default<br>D:     Accepted Transfer Syntax: =LittleEndianImplicit<br>D: Requested Extended Negotiation: none<br>D: Accepted Extended Negotiation:  none<br>D: Requested User Identity Negotiation: none<br>D: User Identity Negotiation Response:  none<br>D: ======================= END A-ASSOCIATE-AC ======================<br>I: Association Accepted (Max Send PDV: 32756)<br></code></pre></td></tr></table></figure>

<p>之后是利用P-DATA PDU发送C-MOVE请求。可以看到C-MOVE消息格式与C-FIND相似。</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Sending</span> <span class="hljs-variable">Move</span> <span class="hljs-variable">Request</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">OUTGOING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">MOVE</span> <span class="hljs-variable">RQ</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Presentation</span> <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span>       <span class="hljs-operator">:</span> <span class="hljs-number">3</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span>                    <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">MOVEPatientRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Priority</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">medium</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Move</span> <span class="hljs-variable">Destination</span>              <span class="hljs-operator">:</span> <span class="hljs-variable">DCMTK</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Request</span> <span class="hljs-variable">Identifiers</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Dicom</span><span class="hljs-operator">-</span><span class="hljs-variable">Data</span><span class="hljs-operator">-</span><span class="hljs-built_in">Set</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Used</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">:</span> <span class="hljs-variable">Little</span> <span class="hljs-variable">Endian</span> <span class="hljs-variable">Explicit</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0008</span><span class="hljs-operator">,</span><span class="hljs-number">0052</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">CS</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">STUDY</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">QueryRetrieveLevel</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0010</span><span class="hljs-operator">,</span><span class="hljs-number">0020</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">LO</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Case1</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">PatientID</span><br></code></pre></td></tr></table></figure>

<p>在SCP端经过处理C-MOVE请求，向SCU发起连接请求，这个请求中包含一个<code>SecondaryCaptureImageStorage</code> Presentation Context，这与之前讲到的C-MOVE连接请求也一致。可以看到对方发来的被叫应用名称就是之前在<code>-aem</code>参数中指定的名称。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span>: <br><span class="hljs-attribute">D</span>: Association Received: <span class="hljs-number">59</span><br><span class="hljs-attribute">D</span>: setting network send timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: setting network receive timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: PDU Type: Associate Request, PDU Length: <span class="hljs-number">216</span> + <span class="hljs-number">6</span> bytes PDU header<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  d<span class="hljs-number">8</span>  <span class="hljs-number">00</span>  <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">44</span>  <span class="hljs-number">43</span>  <span class="hljs-number">4</span>d  <span class="hljs-number">54</span>  <span class="hljs-number">4</span>b  <span class="hljs-number">20</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">43</span>  <span class="hljs-number">4</span>f  <span class="hljs-number">4</span>e  <span class="hljs-number">51</span>  <span class="hljs-number">55</span>  <span class="hljs-number">45</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">53</span>  <span class="hljs-number">54</span>  <span class="hljs-number">53</span>  <span class="hljs-number">52</span>  <span class="hljs-number">56</span>  <span class="hljs-number">31</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">10</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">15</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">20</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">36</span>  <span class="hljs-number">77</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">30</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">19</span>  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">34</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">37</span>  <span class="hljs-number">40</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">11</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">50</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">3</span>d  <span class="hljs-number">51</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">04</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">80</span>  <span class="hljs-number">00</span>  <span class="hljs-number">52</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">22</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">32</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">36</span>  <span class="hljs-number">38</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">34</span>  <span class="hljs-number">33</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">33</span>  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">36</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">31</span>  <span class="hljs-number">55</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">0</span>b  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>f  <span class="hljs-number">57</span>  <span class="hljs-number">49</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Parsing an A-ASSOCIATE PDU<br><span class="hljs-attribute">I</span>: Sub-Association Received<br><span class="hljs-attribute">D</span>: Parameters:<br><span class="hljs-attribute">D</span>: ====================== BEGIN A-ASSOCIATE-RQ =====================<br><span class="hljs-attribute">D</span>: Our Implementation Class UID:      <span class="hljs-number">1.2.276.0</span>.<span class="hljs-number">7230010</span>.<span class="hljs-number">3.0.3.6</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">D</span>: Our Implementation Version Name:   OFFIS_DCMTK_<span class="hljs-number">366</span><br><span class="hljs-attribute">D</span>: Their Implementation Class UID:    <span class="hljs-number">1.2.826.0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3680043</span>.<span class="hljs-number">2</span>.<span class="hljs-number">135</span>.<span class="hljs-number">1066</span>.<span class="hljs-number">101</span><br><span class="hljs-attribute">D</span>: Their Implementation Version Name: <span class="hljs-number">1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/WIN<span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Application Context Name:    <span class="hljs-number">1.2.840.100</span><span class="hljs-number">08.3.1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Calling Application Name:    CONQUESTSRV<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Called Application Name:     DCMTK<br><span class="hljs-attribute">D</span>: Responding Application Name: <br><span class="hljs-attribute">D</span>: Our Max PDU Receive Size:    <span class="hljs-number">16384</span><br><span class="hljs-attribute">D</span>: Their Max PDU Receive Size:  <span class="hljs-number">32768</span><br><span class="hljs-attribute">D</span>: Presentation Contexts:<br><span class="hljs-attribute">D</span>:   Context ID:        <span class="hljs-number">119</span> (Proposed)<br><span class="hljs-attribute">D</span>:     Abstract Syntax: =SecondaryCaptureImageStorage<br><span class="hljs-attribute">D</span>:     Proposed SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Proposed Transfer Syntax(es):<br><span class="hljs-attribute">D</span>:       =LittleEndianImplicit<br><span class="hljs-attribute">D</span>: Requested Extended Negotiation: none<br><span class="hljs-attribute">D</span>: Accepted Extended Negotiation:  none<br><span class="hljs-attribute">D</span>: Requested User Identity Negotiation: none<br><span class="hljs-attribute">D</span>: User Identity Negotiation Response:  none<br><span class="hljs-attribute">D</span>: ======================= END A-ASSOCIATE-RQ ======================<br><span class="hljs-attribute">D</span>: Constructing Associate AC PDU<br><span class="hljs-attribute">I</span>: Sub-Association Acknowledged (Max Send PDV: <span class="hljs-number">32756</span>)<br><span class="hljs-attribute">D</span>: ====================== BEGIN A-ASSOCIATE-AC =====================<br><span class="hljs-attribute">D</span>: Our Implementation Class UID:      <span class="hljs-number">1.2.276.0</span>.<span class="hljs-number">7230010</span>.<span class="hljs-number">3.0.3.6</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">D</span>: Our Implementation Version Name:   OFFIS_DCMTK_<span class="hljs-number">366</span><br><span class="hljs-attribute">D</span>: Their Implementation Class UID:    <span class="hljs-number">1.2.826.0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3680043</span>.<span class="hljs-number">2</span>.<span class="hljs-number">135</span>.<span class="hljs-number">1066</span>.<span class="hljs-number">101</span><br><span class="hljs-attribute">D</span>: Their Implementation Version Name: <span class="hljs-number">1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/WIN<span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Application Context Name:    <span class="hljs-number">1.2.840.100</span><span class="hljs-number">08.3.1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Calling Application Name:    CONQUESTSRV<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Called Application Name:     DCMTK<br><span class="hljs-attribute">D</span>: Responding Application Name: <br><span class="hljs-attribute">D</span>: Our Max PDU Receive Size:    <span class="hljs-number">16384</span><br><span class="hljs-attribute">D</span>: Their Max PDU Receive Size:  <span class="hljs-number">32768</span><br><span class="hljs-attribute">D</span>: Presentation Contexts:<br><span class="hljs-attribute">D</span>:   Context ID:        <span class="hljs-number">119</span> (Accepted)<br><span class="hljs-attribute">D</span>:     Abstract Syntax: =SecondaryCaptureImageStorage<br><span class="hljs-attribute">D</span>:     Proposed SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted Transfer Syntax: =LittleEndianImplicit<br><span class="hljs-attribute">D</span>: Requested Extended Negotiation: none<br><span class="hljs-attribute">D</span>: Accepted Extended Negotiation:  none<br><span class="hljs-attribute">D</span>: Requested User Identity Negotiation: none<br><span class="hljs-attribute">D</span>: User Identity Negotiation Response:  none<br><span class="hljs-attribute">D</span>: ======================= END A-ASSOCIATE-AC ======================<br><span class="hljs-attribute">D</span>: DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>建立反向连接后，就可以接受对方的C-STORE请求，开始传输。</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">I:</span> Received Store Request<br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-STORE RQ<br><span class="hljs-symbol">D:</span> Presentation Context ID       : <span class="hljs-number">119</span><br><span class="hljs-symbol">D:</span> Message ID                    : <span class="hljs-number">3203</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : SecondaryCaptureImageStorage<br><span class="hljs-symbol">D:</span> Affected SOP Instance UID     : <span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">60.0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : present<br><span class="hljs-symbol">D:</span> Priority                      : medium<br><span class="hljs-symbol">D:</span> Move Originator AE Title      : MOVESCU<br><span class="hljs-symbol">D:</span> Move Originator ID            : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingValue (<span class="hljs-number">0028</span>,<span class="hljs-number">0120</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingRangeLimit (<span class="hljs-number">0028</span>,<span class="hljs-number">0121</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">W:</span> DICOM file already exists, overwriting: SC.<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">60.0</span><br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() Version <span class="hljs-keyword">of</span> MetaHeader <span class="hljs-built_in">is</span> ok: <span class="hljs-number">0</span>x0001<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPClassUID [<span class="hljs-number">1.2</span>.<span class="hljs-number">840.10008</span>.<span class="hljs-number">5.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">1.7</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPInstanceUID [<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">60.0</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use <span class="hljs-built_in">new</span> TransferSyntaxUID [Little Endian Implicit] <span class="hljs-keyword">on</span> writing following Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::validateMetaInfo() found <span class="hljs-number">7</span> Elements <span class="hljs-keyword">in</span> DcmMetaInfo <span class="hljs-comment">&#x27;metinf&#x27;</span><br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>在一个C-STORE传输完成后，就会收到一个C-MOVE响应，但由于还有其他传输在进行，所以<code>DIMSE Status</code>为Pending。然后就是下一个C-STORE请求和对应的传输过程与响应。</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">I:</span> Received Move Response <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-MOVE RSP<br><span class="hljs-symbol">D:</span> Message ID Being Responded <span class="hljs-keyword">To</span> : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : MOVEPatientRootQueryRetrieveInformationModel<br><span class="hljs-symbol">D:</span> Remaining Suboperations       : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Completed Suboperations       : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Failed Suboperations          : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Warning Suboperations         : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : none<br><span class="hljs-symbol">D:</span> DIMSE Status                  : <span class="hljs-number">0</span>xff00: Pending: <span class="hljs-keyword">Sub</span>-operations are continuing<br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">I:</span> Received Store Request<br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-STORE RQ<br><span class="hljs-symbol">D:</span> Presentation Context ID       : <span class="hljs-number">119</span><br><span class="hljs-symbol">D:</span> Message ID                    : <span class="hljs-number">3225</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : SecondaryCaptureImageStorage<br><span class="hljs-symbol">D:</span> Affected SOP Instance UID     : <span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">67.0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : present<br><span class="hljs-symbol">D:</span> Priority                      : medium<br><span class="hljs-symbol">D:</span> Move Originator AE Title      : MOVESCU<br><span class="hljs-symbol">D:</span> Move Originator ID            : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingValue (<span class="hljs-number">0028</span>,<span class="hljs-number">0120</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingRangeLimit (<span class="hljs-number">0028</span>,<span class="hljs-number">0121</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">W:</span> DICOM file already exists, overwriting: SC.<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">67.0</span><br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() Version <span class="hljs-keyword">of</span> MetaHeader <span class="hljs-built_in">is</span> ok: <span class="hljs-number">0</span>x0001<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPClassUID [<span class="hljs-number">1.2</span>.<span class="hljs-number">840.10008</span>.<span class="hljs-number">5.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">1.7</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPInstanceUID [<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">67.0</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use <span class="hljs-built_in">new</span> TransferSyntaxUID [Little Endian Implicit] <span class="hljs-keyword">on</span> writing following Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::validateMetaInfo() found <span class="hljs-number">7</span> Elements <span class="hljs-keyword">in</span> DcmMetaInfo <span class="hljs-comment">&#x27;metinf&#x27;</span><br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">I:</span> Received Move Response <span class="hljs-number">2</span><br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-MOVE RSP<br><span class="hljs-symbol">D:</span> Message ID Being Responded <span class="hljs-keyword">To</span> : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : MOVEPatientRootQueryRetrieveInformationModel<br><span class="hljs-symbol">D:</span> Remaining Suboperations       : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Completed Suboperations       : <span class="hljs-number">2</span><br><span class="hljs-symbol">D:</span> Failed Suboperations          : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Warning Suboperations         : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : none<br><span class="hljs-symbol">D:</span> DIMSE Status                  : <span class="hljs-number">0</span>xff00: Pending: <span class="hljs-keyword">Sub</span>-operations are continuing<br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>在所有C-STORE请求完成后，服务端会发来一个表示成功的C-STORE响应：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-variable">Final</span> <span class="hljs-variable">Move</span> <span class="hljs-variable">Response</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">MOVE</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">MOVEPatientRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Remaining</span> <span class="hljs-variable">Suboperations</span>       <span class="hljs-operator">:</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Completed</span> <span class="hljs-variable">Suboperations</span>       <span class="hljs-operator">:</span> <span class="hljs-number">2</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Failed</span> <span class="hljs-variable">Suboperations</span>          <span class="hljs-operator">:</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Warning</span> <span class="hljs-variable">Suboperations</span>         <span class="hljs-operator">:</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">none</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Success</span><span class="hljs-operator">:</span> <span class="hljs-variable">Sub</span><span class="hljs-operator">-</span><span class="hljs-variable">operations</span> <span class="hljs-variable">complete</span> <span class="hljs-operator">-</span> <span class="hljs-variable">No</span> <span class="hljs-variable">failures</span> <span class="hljs-variable">or</span> <span class="hljs-variable">warnings</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Releasing</span> <span class="hljs-built_in">Association</span><br></code></pre></td></tr></table></figure>

<p>至此C-MOVE传输完成。</p>
<p>图像文件传输为PDV=4096Bytes的TCP传输：</p>
<img src="image-20211013195720471.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013195720471" style="zoom:50%;" />

<p> 下载到本地的文件可以打开进行查看和处理，比如使用DCMTK中的工具包或者其他第三方软件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ getscu -k 08,52=STUDY -k StudyInstanceUID=1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.61.0  192.168.31.156 5678  <br>➜  ~ ls -lt<br>total 148576<br>-rw-r--r--    1 zzy   staff  31354908 10  8 22:46 SC.1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.67.0<br>-rw-r--r--    1 zzy   staff   4367746 10  8 22:45 SC.1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.60.0<br></code></pre></td></tr></table></figure>

<h3 id="C-GET"><a href="#C-GET" class="headerlink" title="C-GET"></a>C-GET</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ sudo getscu -v -k 08,52=STUDY -k StudyInstanceUID=1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.61.0  192.168.31.156 5678  <br>I: Requesting Association<br>I: Association Accepted (Max Send PDV: 32756)<br>I: Sending C-GET Request (MsgID 1)<br>I: Received C-STORE Request (MsgID 4261)<br>I: Sending C-STORE Response (Success)<br>I: Received C-GET Response (Pending)<br>I: Received C-STORE Request (MsgID 4281)<br>I: Sending C-STORE Response (Success)<br>I: Received C-GET Response (Pending)<br>I: Received C-GET Response (Success)<br>I: Final status report from last C-GET message:<br>I:   Number of Remaining Suboperations : 0<br>I:   Number of Completed Suboperations : 2<br>I:   Number of Failed Suboperations    : 0<br>I:   Number of Warning Suboperations   : 0<br>I: Releasing Association<br></code></pre></td></tr></table></figure>

<p>C-GET的过程相比C-MOVE要更简单，它在建立连接时会像C-STORE一样将所有的Presentation Context发送。</p>
<img src="image-20211013234755122.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013234755122" style="zoom:50%;" />

<p>下面是C-GET的消息内容，与C-FIND结构相似：</p>
<img src="image-20211013195701896.png" srcset="/StaticBlog/img/loading.gif" lazyload alt="image-20211013195701896" style="zoom:50%;" />

<p>在发送完C-GET消息后，对方会发来C-STORE消息，开始传输。</p>
<h3 id="三．结果与讨论"><a href="#三．结果与讨论" class="headerlink" title="三．结果与讨论"></a>三．结果与讨论</h3><p>在本项目中，我主要是以DICOM标准为依据，通过选用实现了DICOM标准的开源DCMTK工具包作为Modality和View Station，CONQUEST作为Server，完成了满足DICOM标准11种协议的mini-PACS系统。在过程中，通过对DICOM标准的阅读和抓包软件的分析，了解了DICOM图像传输协议的结构，了解了其TCP -&gt; ULP -&gt; PDU -&gt; DATA的设计。基于以上理解可以非常清晰地理解传输的详细过程，即通过Associate PDU和Release PDU控制连接，通过P-DATA传输数据，数据中包含依照DICOM3.0的格式严格定义的消息，这样在实现了相关接口的客户端和服务器之间就能实现DICOM规定的传输功能。</p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><ol>
<li>pydicom文档：<a target="_blank" rel="noopener" href="https://pydicom.github.io/pynetdicom/stable/user/presentation.html">https://pydicom.github.io/pynetdicom/stable/user/presentation.html</a></li>
<li>DICOM标准3.0：<a target="_blank" rel="noopener" href="http://dicom.nema.org/medical/dicom/current/output/chtml/">http://dicom.nema.org/medical/dicom/current/output/chtml/</a></li>
<li>DICOM通信流程：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6f178fc98a04">https://www.jianshu.com/p/6f178fc98a04</a></li>
<li>DCMTK文档：<a target="_blank" rel="noopener" href="https://support.dcmtk.org/docs">https://support.dcmtk.org/docs</a></li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/StaticBlog/tags/DICOM/">DICOM</a>
                    
                      <a class="hover-with-bg" href="/StaticBlog/tags/Biomedical-Engineering/">Biomedical Engineering</a>
                    
                      <a class="hover-with-bg" href="/StaticBlog/tags/Biomedical-Imaging/">Biomedical Imaging</a>
                    
                      <a class="hover-with-bg" href="/StaticBlog/tags/Network/">Network</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/StaticBlog/2022/04/24/dmzjReader/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">泡面盖拯救计划：在世界读书日用JS制作电子书</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/StaticBlog/2021/10/09/hexo-i18n-by-article-translator/">
                        <span class="hidden-mobile">Markdown文章自动翻译</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-1"></div>
     
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrow-up-alt" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a>Made with </a> <i class="iconfont icon-love"></i> <a> by </a> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo </span></a> and <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>  Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/StaticBlog/js/events.js" ></script>
<script  src="/StaticBlog/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/StaticBlog/js/local-search.js" ></script>



  
    <script  src="/StaticBlog/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/StaticBlog/js/boot.js" ></script>


</body>
</html>
