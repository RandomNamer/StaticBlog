

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/StaticBlog/en/img/favicon.png">
  <link rel="icon" href="/StaticBlog/en/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Yet another course project of Biomedical Engineering.">
  <meta name="author" content="Zeyu Zhang">
  <meta name="keywords" content="">
  <meta name="description" content="Yet another course project of Biomedical Engineering.">
<meta property="og:type" content="article">
<meta property="og:title" content="Analysis of DICOM Transfer Protocols">
<meta property="og:url" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/index.html">
<meta property="og:site_name" content="A Random Blog">
<meta property="og:description" content="Yet another course project of Biomedical Engineering.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930193320612.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930193338568.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930194603984.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013183425277.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013183453881.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013183507932.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013231631533.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013231904790.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013195720471.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013234755122.png">
<meta property="og:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20211013195701896.png">
<meta property="article:published_time" content="2021-11-11T13:14:06.000Z">
<meta property="article:modified_time" content="2022-04-26T09:27:46.386Z">
<meta property="article:author" content="Zeyu Zhang">
<meta property="article:tag" content="DICOM">
<meta property="article:tag" content="Biomedical Engineering">
<meta property="article:tag" content="Biomedical Imaging">
<meta property="article:tag" content="Network">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://randomnamer.github.io/2021/11/11/DICOM-protocol-internals/image-20210930193320612.png">
  
  <title>Analysis of DICOM Transfer Protocols - A Random Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/StaticBlog/en/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/StaticBlog/en/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/StaticBlog/en/assets/icon/iconfont/iconfont.css">
<link rel="stylesheet" href="/StaticBlog/en/css/layout.css">
<link rel="stylesheet" href="/StaticBlog/en/css/decoration.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"randomnamer.github.io","root":"/StaticBlog/en/","version":"1.8.12","typing":{"enable":true,"typeSpeed":40,"cursorChar":"|","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0,"position":"left"},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/StaticBlog/en/local-search.xml"};
  </script>
  <script  src="/StaticBlog/en/js/utils.js" ></script>
  <script  src="/StaticBlog/en/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 50vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/StaticBlog/en/">
      <strong>RandomNamer&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/en/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/en/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/en/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/StaticBlog/en/../">
                <i class="iconfont icon-in-alt"></i>
                中文
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class=" iconfont icon-search-alt" ></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/StaticBlog/en/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Analysis of DICOM Transfer Protocols">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-11 21:14" pubdate>
        November 11, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      31k words
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      39 min to read
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x post-page-container ">
    
      <div class="d-none d-lg-block col-lg-3 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
     
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Analysis of DICOM Transfer Protocols</h1>
            
             
              <p class="note note-primary"> This Page is translated by <span style="font-weight: 700;"> <a target="_blank" rel="noopener" href="https://github.com/RandomNamer/MarkdownTranslator">automatic translation tool</a></span>. Some text may be inaccurate or ambiguous.</p>
            
            
              <p class="note-info"> This article is related to <span style="font-weight: 700;" ><a target="_blank" rel="noopener" href="https://github.com/RandomNamer/BMECourseDesign " >a personal project</a></span>, from which some snippets in this article may be found. </p>
              
            <div class="markdown-body">
              <h2 align='center' style="font-family: serif; font-size: 40px;">DICOM Transfer Protocols Analysis</h2>

<blockquote>
<p>This blog is an excerpt from one of my <a target="_blank" rel="noopener" href="https://github.com/RandomNamer/BMECourseDesign">course design</a> reports.</p>
</blockquote>
<h2 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h2><h3 id="Introduction-to-PACS"><a href="#Introduction-to-PACS" class="headerlink" title="Introduction to PACS"></a>Introduction to PACS</h3><p>Image Archiving and Communication System (PACS) is a medical imaging technology that provides functions such as storage, access, and search of images of multiple modalities. The common format for PACS image storage and transmission is DICOM, and PACS itself is part of the DICOM standard. The PACS system consists of Modality, Server and View Station, which can be considered as an implementation of the client/service model. The modal and the viewer belong to the user (Service Class User, SCU), and the server is called the Service Class Provider, abbreviated as SCP.</p>
<p>In implementation, modalities are typically digital imaging devices such as computed tomography (CT), ultrasound, nuclear medicine, positron emission tomography (PET), and magnetic resonance imaging (MRI). The modality can be sent to a quality assurance (QA) workstation first, and if the information is correct, the image will be passed to the server for storage. This step comes from the C-STORE protocol in the DICOM standard. View Station is a place where radiologists review patient research and formulate diagnoses. Its basic function is to perform addition, deletion, and modification operations on the data in the server, which is implemented by C-FIND, C-MOVE, and C-GET in the DICOM standard. In View Station, peripheral facilities such as reporting systems can also be inherited, and integrated with other information systems in the hospital, such as the electronic medical record system EMR, to form an end-to-end workflow.</p>
<h4 id="DCMTK"><a href="#DCMTK" class="headerlink" title="DCMTK"></a>DCMTK</h4><p>Here we use the DCMTK toolkit as Modality and View Station. DCMTK is a set of open source packages and libraries that implement the DCM standard. It is developed using C++ and is cross-platform. Most of the DICOM standard is implemented in DCMTK, including image opening, conversion and verification functions, and the transmission of DICOM files over the Internet.</p>
<p>This time, DCMTK is built on the macOS system, and the builds on other UNIX-like systems should also have the same steps. The <code>CMakelist</code> corresponding to various systems has been written in the DCMTK source code, and you only need to execute <code>cmake</code> to complete the configuration. Then <code>make</code> in the source file path can build the entire project. After the build is successful, the corresponding static library files and binary executable files will be output:</p>
<img src="image-20210930193320612.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20210930193320612" style="zoom:33%;" />


<img src="image-20210930193338568.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20210930193338568" style="zoom:33%;" />


<p>The output has a set of command line tools and the corresponding static link library, which meets the needs of users to call through system commands and direct link calls, which is very convenient for secondary development. At the same time, we can also directly use the generated command line tools to perform various DICOM operations. For example, we can use the <code>storescu</code> as modality to send DICOM files to the server. The format sent is</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">storescu [options] peer port dcmfile-in...<br></code></pre></td></tr></table></figure>

<h4 id="CONQEST-SERVER"><a href="#CONQEST-SERVER" class="headerlink" title="CONQEST SERVER"></a>CONQEST SERVER</h4><p>CONQUEST is a lightweight DICOM SERVER that implements the DIMSE message mechanism and supports multiple databases.</p>
<h2 id="2-Image-communication-and-its-parameter-analysis"><a href="#2-Image-communication-and-its-parameter-analysis" class="headerlink" title="2. Image communication and its parameter analysis"></a>2. Image communication and its parameter analysis</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>DICOM is a high-level protocol built on top of TCP/IP. The bottom layer of the DICOM protocol is ULP (Upper Layer Protocol). It is mainly responsible for connecting with TCP. After the DICOM application entity completes the message exchange through DIMSE, the DICOM upper protocol layer ULP is required to provide transmission support.</p>
<p>ULP provides 5 connection control services: A-ASSOCIATE, A-RELEASE, A-ABORT, P-DATA, A-P-ABORT.</p>
<ul>
<li>A-ASSOCIATE:</li>
<li>A-RELEASE:</li>
<li>A-ABORT:</li>
<li>P-DATA:</li>
<li>A-P-ABORT:</li>
</ul>
<p>ULP provides 7 protocol data units (Protocol Data Unit, PDU) to realize the above-mentioned 5 kinds of services.</p>
<ul>
<li>A-ASSOCIATE-RQ:</li>
<li>A-ASSOCIATE-AC:</li>
<li>A-ASSOCIATE-RJ:</li>
<li>P-DATA-TF:</li>
<li>A-RELEASE-RQ:</li>
<li>A-RELEASE-RP:</li>
<li>A-ABORT:</li>
</ul>
<p>The process of DICOM image transmission can also be inferred from the foregoing: the connection is established through the Association PDU, the actual transmission is performed through the P-DATA-TF PDU, and the connection is released through the Release PDU after the transmission is completed, or A-ABORT is used to terminate the connection during transmission.</p>
<p>The details of the communication will be described below.</p>
<h3 id="C-STORE"><a href="#C-STORE" class="headerlink" title="C-STORE"></a>C-STORE</h3><p>The <code>-v -d</code> parameter is used here to enable the command line tool of DCMTK to output detailed logs in Debug mode, and a network packet capture tool can also be used for auxiliary analysis.</p>
<img src="image-20210930194603984.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20210930194603984" style="zoom:50%;" />

<p>The log includes the detailed process of connection establishment, transmission, and completion of the transmission between the two parties, including the request and response information <code>A-ASSOCIATE-RQ</code>, <code>A-ASSOCIATE-AC</code>, the DIMSE information of the store request and the received information when the connection is established. DIMSE information that the store responds to.</p>
<h4 id="connection-establishment"><a href="#connection-establishment" class="headerlink" title="connection establishment"></a>connection establishment</h4><p>In the DICOM standard, the connection request A-ASSOCIATE-RQ is described as follows:</p>
<ul>
<li><p>**PDU</p>
</li>
<li><p>:————:</p>
</li>
<li><p>1</p>
</li>
<li><p>02</p>
</li>
<li><p>3-6</p>
</li>
<li><p>7-8</p>
</li>
<li><p>9-10</p>
</li>
<li><p>11-26</p>
</li>
<li><p>27-42</p>
</li>
<li><p>43-74</p>
</li>
<li><p>75-xxx</p>
</li>
<li><p>6</p>
</li>
</ul>
<p>After the server receives the request, the server will start to parse the information carried in the request, mainly to check the carried Presentation Context, and will respond when the conditions are met, and then return the ASSOCIATE-AC message, whose structure is defined as follows:</p>
<ul>
<li>**PDU</li>
<li>:————:</li>
<li>1</li>
<li>2</li>
<li>3-6</li>
<li>7-8</li>
<li>9-10</li>
<li>11-26</li>
<li>27-42</li>
<li>43-74</li>
<li>75-xxx</li>
</ul>
<h4 id="Presentation-Context"><a href="#Presentation-Context" class="headerlink" title="Presentation Context"></a>Presentation Context</h4><p>Presentation Context is a representation in the DICOM protocol that specifies the form of transport supported by the client. It describes in detail the structure and encoding format of the content of this type of fragment. It consists of 3 parts: a Context ID, an Abstract Syntax and multiple Transfer Syntax.</p>
<ul>
<li>Positive odd numbers between 255</li>
</ul>
<ol start="2">
<li><strong>Abstract Syntax</strong> is the meaning of data representation, usually represented by DICOM SOP Class UID, such as the following two IDs; at the same time, it can also be represented by private ID to realize the transmission of custom image types.</li>
</ol>
<ul>
<li><code>1.2.840.10008.1.1</code></li>
<li><code>1.2.840.10008.5.1.4.1.1</code></li>
</ul>
<ol start="3">
<li><strong>Transfer Syntax</strong> is the data encoding format. Usually represented by DICOM Transfer Syntax Class UID, such as the following two IDs; at the same time, it can also be represented by private ID to realize the transfer of custom image types.</li>
</ol>
<ul>
<li><code>1.2.840.10008.1.2</code></li>
<li><code>1.2.840.10008.1.2.4.50</code></li>
</ul>
<p>The logs of dcmtk can help us to parse the Presentation Context as follows:</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>		 <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span><span class="hljs-operator">:</span>        <span class="hljs-number">45</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Proposed</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>     <span class="hljs-variable">Abstract</span> <span class="hljs-built_in">Syntax</span><span class="hljs-operator">:</span> <span class="hljs-operator">=</span><span class="hljs-variable">DigitalIntraOralXRayImageStorageForPresentation</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>     <span class="hljs-variable">Proposed</span> <span class="hljs-variable">SCP</span><span class="hljs-operator">/</span><span class="hljs-variable">SCU</span> <span class="hljs-variable">Role</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Default</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>     <span class="hljs-variable">Proposed</span> <span class="hljs-variable">Transfer</span> <span class="hljs-built_in">Syntax</span><span class="hljs-punctuation">(</span><span class="hljs-variable">es</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span>       <span class="hljs-operator">=</span><span class="hljs-variable">LittleEndianExplicit</span><br></code></pre></td></tr></table></figure>

<p>In the Server, open the Debug mode log, and also print the Presentation Context carried in ASSOCIATE-RQ:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">45</span>: STARTED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">18</span>:<span class="hljs-number">25</span>:<span class="hljs-number">41</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] A-ASSOCIATE-RQ Packet Dump<br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Calling Application Title : <span class="hljs-string">&quot;STORESCU        &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Called Application Title : <span class="hljs-string">&quot;ANY-SCP         &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Application Context : <span class="hljs-string">&quot;1.2.840.10008.3.1.1.1&quot;</span>, PDU length: <span class="hljs-number">16384</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Number of Proposed Presentation Contexts: <span class="hljs-number">128</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">0</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.1.9.1.3&quot;</span> <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">1</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.1.9.1.3&quot;</span> <span class="hljs-number">1</span><br>...<br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">127</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.1.12.2&quot;</span> <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Server Command   := <span class="hljs-number">0001</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Message ID       := <span class="hljs-number">0001</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] FreeStore Left <span class="hljs-number">17269</span> <span class="hljs-keyword">on</span> c:\<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Written file: c:\users\admi\desktop\dicomserver150b\data\MF<span class="hljs-number">-0000012</span>\<span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span><span class="hljs-number">.5962</span><span class="hljs-number">.1</span><span class="hljs-number">.3</span><span class="hljs-number">.5012</span><span class="hljs-number">.1</span><span class="hljs-number">.1166546115</span><span class="hljs-number">.14677</span>_0001_000001_16341207560000.dcm<br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">45</span>: ENDED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">18</span>:<span class="hljs-number">25</span>:<span class="hljs-number">56</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">45</span>: TOTAL RUNNING TIME: <span class="hljs-number">15</span> SECONDS<br></code></pre></td></tr></table></figure>

<h4 id="DIMSE"><a href="#DIMSE" class="headerlink" title="DIMSE"></a>DIMSE</h4><p>DIMSE (DICOM Message Service Element) is a message format transmitted under P-DATA PDU. There are 11 DIMSE services in the DICOM3.0 protocol:</p>
<ul>
<li><strong>Name</strong></li>
</ul>
<hr>
<p>| C-STORE        | DIMSE-C   | operation    |<br>| C-GET          | DIMSE-C   | operation    |<br>| C-MOVE         | DIMSE-C   | operation    |<br>| C-FIND         | DIMSE-C   | operation    |<br>| C-ECHO         | DIMSE-C   | operation    |<br>| N-EVENT-REPORT | DIMSE-N   | notification |<br>| N-GET          | DIMSE-N   | operation    |<br>| N-SET          | DIMSE-N   | operation    |<br>| N-ACTION       | DIMSE-N   | operation    |<br>| N-CREATE       | DIMSE-N   | operation    |<br>| N-DELETE       | DIMSE-N   | operation    |</p>
<p>这里还是以C-STORE为例进行分析。在收到服务端返回的ASSOCIATE-AC报文后，就正式发起store请求，进行传输。日志种会输出本次传输的DIMSE信息。</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">OUTGOING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">STORE</span> <span class="hljs-variable">RQ</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span>                    <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">SecondaryCaptureImageStorage</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Instance</span> <span class="hljs-variable">UID</span>     <span class="hljs-operator">:</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span><span class="hljs-number">.5962</span><span class="hljs-number">.99</span><span class="hljs-number">.1</span><span class="hljs-number">.2280943358</span><span class="hljs-number">.716200484</span><span class="hljs-number">.1363785608958</span><span class="hljs-number">.60</span><span class="hljs-number">.0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Priority</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">medium</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-variable">Store</span> <span class="hljs-variable">Response</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">STORE</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Presentation</span> <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span>       <span class="hljs-operator">:</span> <span class="hljs-number">203</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">SecondaryCaptureImageStorage</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Instance</span> <span class="hljs-variable">UID</span>     <span class="hljs-operator">:</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span><span class="hljs-number">.5962</span><span class="hljs-number">.99</span><span class="hljs-number">.1</span><span class="hljs-number">.2280943358</span><span class="hljs-number">.716200484</span><span class="hljs-number">.1363785608958</span><span class="hljs-number">.60</span><span class="hljs-number">.0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">none</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Success</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br></code></pre></td></tr></table></figure>

<p>在传输完成后，即可在服务端数据库看到这个图像，说明传输已经成功。</p>
<img src="image-20211013183425277.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013183425277" style="zoom:50%;" />

<h4 id="传输"><a href="#传输" class="headerlink" title="传输"></a>传输</h4><p>DIMSE传输与DICOM图像传输都是用P-DATA PDU，这里通过抓包软件对它们进行分析。</p>
<p>在A-ASSOCIATE AC消息之后，两者开始通过P-DATA PDU进行传输。首先我们可以看到C-STORE RQ这一DIMSE消息的报文。其信息内容与之前日志输出的完全一致。</p>
<img src="image-20211013183453881.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013183453881" style="zoom:50%;" />

<p>然后我们可以看到DCM文件被实际传输。PDV长度为32768B（32KB），实际上由24个长度为1514字节的TCP帧构成。传输的内容是小端序，未压缩，无加密。</p>
<img src="image-20211013183507932.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013183507932" style="zoom:50%;" />

<h3 id="C-FIND"><a href="#C-FIND" class="headerlink" title="C-FIND"></a>C-FIND</h3><h4 id="Information-Model"><a href="#Information-Model" class="headerlink" title="Information Model"></a>Information Model</h4><p>在DICOM标准中，查询/取回的信息模型有以下三种：</p>
<ul>
<li>Patient Root</li>
<li>Study Root</li>
<li>Patient/Study Only</li>
</ul>
<p>例如，在患者根模型中，有四种层级的分类：</p>
<ul>
<li>Patient：对应Patient Information Entity (IE)</li>
<li>Study：对应一个患者和Study IE</li>
<li>Series：Series依赖具体的modality，在一个study中。它对应着Series, Frame of Reference 和Equipment IE。</li>
<li>Composite Object Instance：对应Composite Object IE。</li>
</ul>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>C-FIND查询使用Key- Value进行，查询在SCP中会被转换为对应的SQL语句，向数据库发起查询。</p>
<table>
<thead>
<tr>
<th align="center"><strong>描述/模块</strong></th>
<th align="center"><strong>标签</strong></th>
<th align="center"><strong>匹配密钥类型</strong></th>
<th align="center"><strong>返回密钥类型</strong></th>
<th align="center"><strong>备注/匹配类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">病人姓名</td>
<td align="center">（0010,0010）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者ID</td>
<td align="center">（0010,0020）</td>
<td align="center">R</td>
<td align="center">1</td>
<td align="center">请求标识符中应显示。应使用单值匹配检索。注意由于预计只有一个响应，这是一个唯一的密钥。</td>
</tr>
<tr>
<td align="center">患者ID的发行人</td>
<td align="center">（0010,0021）</td>
<td align="center">R</td>
<td align="center">2</td>
<td align="center">应使用单值匹配检索。在有多个发行商的情况下，此密钥限制将患者ID（0010,0020）与患者ID（0010,0020）唯一域匹配。</td>
</tr>
<tr>
<td align="center">患者的出生日期</td>
<td align="center">（0010,0030）</td>
<td align="center">—</td>
<td align="center">2</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者的性别</td>
<td align="center">（0010,0040）</td>
<td align="center">—</td>
<td align="center">2</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者识别模块的所有其他属性</td>
<td align="center"></td>
<td align="center">—</td>
<td align="center">3</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">患者人口统计模块的所有其他属性</td>
<td align="center"></td>
<td align="center">—</td>
<td align="center">3</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">观察日期时间</td>
<td align="center">（0040，A032）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">值类型</td>
<td align="center">（0040，A040）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center">应与（0040，A043）的第一行相同</td>
</tr>
<tr>
<td align="center">概念名称代码序列</td>
<td align="center">（0040，A043）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center">请求中不应存在，响应中用应与标识符中内容模板序列（0040，A504）中标识的模板相同。</td>
</tr>
<tr>
<td align="center">&gt;代码值</td>
<td align="center">（0008,0100）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;编码方案指示</td>
<td align="center">（0008,0102）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;编码方案版本</td>
<td align="center">（0008,0103）</td>
<td align="center">—</td>
<td align="center">1C</td>
<td align="center">如果编码方案指示（0008,0102）的值不足以明确识别代码值（0008,0100），则为必填项。</td>
</tr>
<tr>
<td align="center">&gt;代码含义</td>
<td align="center">（0008,0104）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;概念名称代码序列的所有其他属性</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">内容序列</td>
<td align="center">（0040，A730）</td>
<td align="center">—</td>
<td align="center">2</td>
<td align="center">内容序列（0040，A730）是一个潜在的递归嵌套项目序列。内容序列应始终在请求标识符中发送零长度。响应数据集中的内容序列应包含所请求模板的内容项。</td>
</tr>
<tr>
<td align="center">&gt;内容序列的所有属性</td>
<td align="center"></td>
<td align="center">—</td>
<td align="center">—</td>
<td align="center">SCP提供的内容项目。对内容项属性类型的要求应符合SR文档内容模块中的定义。</td>
</tr>
<tr>
<td align="center">HL7结构化文档参考序列</td>
<td align="center">（0040，A390）</td>
<td align="center">—</td>
<td align="center">1C</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;参考的SOP类UID</td>
<td align="center">（0008,1150）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;引用的SOP实例UID</td>
<td align="center">（0008,1155）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;HL7实例标识符</td>
<td align="center">（0040，E001）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;检索URI</td>
<td align="center">（0040，E010）</td>
<td align="center">—</td>
<td align="center">3</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">包含其他参考实例序列的研究</td>
<td align="center">（0008,1200）</td>
<td align="center">—</td>
<td align="center">1C</td>
<td align="center">如果内容序列（0040，A390）包含引用使用患者/研究/系列/实例信息模型的SOP实例的内容项，则为必填项。</td>
</tr>
<tr>
<td align="center">&gt;引用系列序列</td>
<td align="center">（0008,1115）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;系列实例UID</td>
<td align="center">（0020,000E）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;引用实例序列</td>
<td align="center">（0008,114A）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;&gt;参考SOP类UID</td>
<td align="center">（0008,1150）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&gt;&gt;&gt;引用的SOP实例UID</td>
<td align="center">（0008,1155）</td>
<td align="center">—</td>
<td align="center">1</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h4><p>C-FIND也同样遵循上述的流程，即先通过Association PDU建立连接，通过P-DATA-TF PDU进行实际传输，传输完成后通过Release PDU进行连接释放。我们试验查询上一次写入的DCM文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ findscu -v -d -S -k &quot;(0008, 0052)=STUDY&quot; -k &quot;(0010,0020)=Case1&quot; 59.78.44.209 5678<br>D: $dcmtk: findscu v3.6.6 2021-01-14 $<br>D: <br>D: DcmDataDictionary: Loading file: /usr/local/Cellar/dcmtk/3.6.6/share/dcmtk/dicom.dic<br>D: Request Parameters:<br>D: ====================== BEGIN A-ASSOCIATE-RQ =====================<br>D: Our Implementation Class UID:      1.2.276.0.7230010.3.0.3.6.6<br>D: Our Implementation Version Name:   OFFIS_DCMTK_366<br>D: Their Implementation Class UID:    <br>D: Their Implementation Version Name: <br>D: Application Context Name:    1.2.840.10008.3.1.1.1<br>D: Calling Application Name:    FINDSCU<br>D: Called Application Name:     ANY-SCP<br>D: Responding Application Name: ANY-SCP<br>D: Our Max PDU Receive Size:    16384<br>D: Their Max PDU Receive Size:  0<br>D: Presentation Contexts:<br>D:   Context ID:        1 (Proposed)<br>D:     Abstract Syntax: =FINDStudyRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Proposed Transfer Syntax(es):<br>D:       =LittleEndianExplicit<br>D:       =BigEndianExplicit<br>D:       =LittleEndianImplicit<br>D: Requested Extended Negotiation: none<br>D: Accepted Extended Negotiation:  none<br>D: Requested User Identity Negotiation: none<br>D: User Identity Negotiation Response:  none<br>D: ======================= END A-ASSOCIATE-RQ ======================<br></code></pre></td></tr></table></figure>

<p>在ASSOCIATE-RQ中，我们可以看到它携带了一个Presentation Context，表示这个是一个StudyRoot的Information Model。对方只要支持这一种Infromation Model即可完成连接。</p>
<p>在DICOM 3.0中，C-FIND-RQ协议规定如下：</p>
<table>
<thead>
<tr>
<th align="center"><strong>Message Field</strong></th>
<th align="center"><strong>Description of Field</strong></th>
</tr>
</thead>
</table>
<ul>
<li>Command</li>
<li>Affected</li>
<li>Command</li>
<li>Message</li>
<li>Priority</li>
<li>Command</li>
<li>Identifier</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span>: Requesting Association<br><span class="hljs-attribute">D</span>: setting network send timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: setting network receive timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: Constructing Associate RQ PDU<br><span class="hljs-attribute">D</span>: PDU Type: Associate Accept, PDU Length: <span class="hljs-number">187</span> + <span class="hljs-number">6</span> bytes PDU header<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">02</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  bb  <span class="hljs-number">00</span>  <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">41</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">59</span>  <span class="hljs-number">2</span>d  <span class="hljs-number">53</span>  <span class="hljs-number">43</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">50</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">46</span>  <span class="hljs-number">49</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">44</span>  <span class="hljs-number">53</span>  <span class="hljs-number">43</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">55</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">10</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">15</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">21</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">19</span>  <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">40</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">11</span>  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">50</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">3</span>d  <span class="hljs-number">51</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">04</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">80</span>  <span class="hljs-number">00</span>  <span class="hljs-number">52</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">22</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">32</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">36</span>  <span class="hljs-number">38</span>  <span class="hljs-number">30</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">30</span>  <span class="hljs-number">34</span>  <span class="hljs-number">33</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">33</span>  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">36</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">30</span>  <span class="hljs-number">31</span>  <span class="hljs-number">55</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">0</span>b  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>f  <span class="hljs-number">57</span>  <span class="hljs-number">49</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">33</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Parsing an A-ASSOCIATE PDU<br><span class="hljs-attribute">D</span>: Association Parameters Negotiated:<br><span class="hljs-attribute">D</span>: ====================== BEGIN A-ASSOCIATE-AC =====================<br><span class="hljs-attribute">D</span>: Our Implementation Class UID:      <span class="hljs-number">1.2.276.0</span>.<span class="hljs-number">7230010</span>.<span class="hljs-number">3.0.3.6</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">D</span>: Our Implementation Version Name:   OFFIS_DCMTK_<span class="hljs-number">366</span><br><span class="hljs-attribute">D</span>: Their Implementation Class UID:    <span class="hljs-number">1.2.826.0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3680043</span>.<span class="hljs-number">2</span>.<span class="hljs-number">135</span>.<span class="hljs-number">1066</span>.<span class="hljs-number">101</span><br><span class="hljs-attribute">D</span>: Their Implementation Version Name: <span class="hljs-number">1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/WIN<span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Application Context Name:    <span class="hljs-number">1.2.840.100</span><span class="hljs-number">08.3.1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Calling Application Name:    FINDSCU<br><span class="hljs-attribute">D</span>: Called Application Name:     ANY-SCP<br><span class="hljs-attribute">D</span>: Responding Application Name: ANY-SCP<br><span class="hljs-attribute">D</span>: Our Max PDU Receive Size:    <span class="hljs-number">16384</span><br><span class="hljs-attribute">D</span>: Their Max PDU Receive Size:  <span class="hljs-number">32768</span><br><span class="hljs-attribute">D</span>: Presentation Contexts:<br><span class="hljs-attribute">D</span>:   Context ID:        <span class="hljs-number">1</span> (Accepted)<br><span class="hljs-attribute">D</span>:     Abstract Syntax: =FINDStudyRootQueryRetrieveInformationModel<br><span class="hljs-attribute">D</span>:     Proposed SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted Transfer Syntax: =LittleEndianImplicit<br><span class="hljs-attribute">D</span>: Requested Extended Negotiation: none<br><span class="hljs-attribute">D</span>: Accepted Extended Negotiation:  none<br><span class="hljs-attribute">D</span>: Requested User Identity Negotiation: none<br><span class="hljs-attribute">D</span>: User Identity Negotiation Response:  none<br><span class="hljs-attribute">D</span>: ======================= END A-ASSOCIATE-AC ======================<br></code></pre></td></tr></table></figure>

<p>The other party will respond and the connection will be established.</p>
<p>Then the DIMSE message is sent at the P-DATA layer. It can be seen that the DIMSE message mainly contains this SOP, which is the Information Model of the StudyRoot query, and also carries two Query.</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Association</span> <span class="hljs-variable">Accepted</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">Max</span> <span class="hljs-variable">Send</span> <span class="hljs-variable">PDV</span><span class="hljs-operator">:</span> <span class="hljs-number">32756</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Sending</span> <span class="hljs-built_in">Find</span> <span class="hljs-variable">Request</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">OUTGOING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">FIND</span> <span class="hljs-variable">RQ</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Presentation</span> <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span>       <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span>                    <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">FINDStudyRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Priority</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">medium</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Request</span> <span class="hljs-variable">Identifiers</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Dicom</span><span class="hljs-operator">-</span><span class="hljs-variable">Data</span><span class="hljs-operator">-</span><span class="hljs-built_in">Set</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Used</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">:</span> <span class="hljs-variable">Little</span> <span class="hljs-variable">Endian</span> <span class="hljs-variable">Explicit</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0008</span><span class="hljs-operator">,</span><span class="hljs-number">0052</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">CS</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">STUDY</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">QueryRetrieveLevel</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0010</span><span class="hljs-operator">,</span><span class="hljs-number">0020</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">LO</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Case1</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">PatientID</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>On the server side, we can check the log to determine the operation mode of the query:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">46</span>: STARTED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">19</span>:<span class="hljs-number">36</span>:<span class="hljs-number">59</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] A-ASSOCIATE-RQ Packet Dump<br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Calling Application Title : <span class="hljs-string">&quot;FINDSCU         &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Called Application Title : <span class="hljs-string">&quot;ANY-SCP         &quot;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Application Context : <span class="hljs-string">&quot;1.2.840.10008.3.1.1.1&quot;</span>, PDU length: <span class="hljs-number">16384</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Number of Proposed Presentation Contexts: <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>]  Presentation Context <span class="hljs-number">0</span> <span class="hljs-string">&quot;1.2.840.10008.5.1.4.1.2.2.1&quot;</span> <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Server Command   := <span class="hljs-number">0020</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Message ID       := <span class="hljs-number">0001</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] (StudyRootQuery) search level: STUDY <br>[<span class="hljs-meta">CONQUESTSRV1</span>] Query On Study<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Issue Query <span class="hljs-keyword">on</span> Columns: DICOMStudies.PatientID<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Values: DICOMStudies.PatientID = <span class="hljs-string">&#x27;Case1&#x27;</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Tables: DICOMStudies<br>[<span class="hljs-meta">CONQUESTSRV1</span>] Sorting ((<span class="hljs-literal">null</span>)) DoSort := <span class="hljs-number">0</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] Records = <span class="hljs-number">1</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] C-Find (StudyRoot) located <span class="hljs-number">1</span> records<br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">46</span>: ENDED AT: Wed Oct <span class="hljs-number">13</span> <span class="hljs-number">19</span>:<span class="hljs-number">36</span>:<span class="hljs-number">59</span> <span class="hljs-number">2021</span><br>[<span class="hljs-meta">CONQUESTSRV1</span>] UPACS THREAD <span class="hljs-number">46</span>: TOTAL RUNNING TIME: <span class="hljs-number">0</span> SECONDS<br></code></pre></td></tr></table></figure>

<p>It can be seen that the server first determines to start the query from Study as the root node, and then starts the query in the PatientID column just specified, finds a record, and then sends a response. The following is the response content parsed by SCU:</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-built_in">Find</span> <span class="hljs-variable">Response</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">FIND</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">FINDStudyRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">xff00</span><span class="hljs-operator">:</span> <span class="hljs-variable">Pending</span><span class="hljs-operator">:</span> <span class="hljs-variable">Matches</span> <span class="hljs-variable">are</span> <span class="hljs-variable">continuing</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Response</span> <span class="hljs-variable">Identifiers</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Dicom</span><span class="hljs-operator">-</span><span class="hljs-variable">Data</span><span class="hljs-operator">-</span><span class="hljs-built_in">Set</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Used</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">:</span> <span class="hljs-variable">Little</span> <span class="hljs-variable">Endian</span> <span class="hljs-variable">Implicit</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0008</span><span class="hljs-operator">,</span><span class="hljs-number">0052</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">CS</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">STUDY</span> <span class="hljs-punctuation">]</span>                                 <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">QueryRetrieveLevel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0010</span><span class="hljs-operator">,</span><span class="hljs-number">0020</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">LO</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Case1</span> <span class="hljs-punctuation">]</span>                                 <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">PatientID</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DcmDataset</span><span class="hljs-string">::read</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-variable">Final</span> <span class="hljs-built_in">Find</span> <span class="hljs-variable">Response</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">FIND</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">FINDStudyRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">none</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Success</span><span class="hljs-operator">:</span> <span class="hljs-variable">Matching</span> <span class="hljs-variable">is</span> <span class="hljs-variable">complete</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Releasing</span> <span class="hljs-built_in">Association</span><br></code></pre></td></tr></table></figure>

<h3 id="C-MOVE"><a href="#C-MOVE" class="headerlink" title="C-MOVE"></a>C-MOVE</h3><p>C-MOVE can be understood that after C-FIND query, the SCP of C-MOVE initiates a C-STORE request to the SCU, and finally transmits the image to the SCU of C-MOVE.</p>
<p>From the analysis of the packet capture software, it can be seen that the SCU first transmits C-MOVE DIMSE to the SCP, and the other party sends a connection request in turn after receiving it.</p>
<img src="image-20211013231631533.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013231631533" style="zoom:50%;" />

<p>After the C-STORE transmission is completed (the PDU side sends a C-STORE RSP), the other party will send a C-MOVE response. After all sub-C-STORE operations are completed, a total C-STORE response will be sent, and both parties will start Disconnect.</p>
<img src="image-20211013231904790.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013231904790" style="zoom:50%;" />

<h4 id="log-analysis"><a href="#log-analysis" class="headerlink" title="log analysis"></a>log analysis</h4><p>The first is that the SCU requests the SCP to establish a connection:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ movescu -v -d -aem &quot;DCMTK&quot; --port 7777 -k 0008,0052=STUDY -k 0010,0020=&quot;Case1&quot; 59.78.44.209 5678<br>D: DcmDataDictionary: Loading file: /usr/local/Cellar/dcmtk/3.6.6/share/dcmtk/dicom.dic<br>D: $dcmtk: movescu v3.6.6 2021-01-14 $<br>D: <br>D: Request Parameters:<br>D: ====================== BEGIN A-ASSOCIATE-RQ =====================<br>D: Our Implementation Class UID:      1.2.276.0.7230010.3.0.3.6.6<br>D: Our Implementation Version Name:   OFFIS_DCMTK_366<br>D: Their Implementation Class UID:    <br>D: Their Implementation Version Name: <br>D: Application Context Name:    1.2.840.10008.3.1.1.1<br>D: Calling Application Name:    MOVESCU<br>D: Called Application Name:     ANY-SCP<br>D: Responding Application Name: ANY-SCP<br>D: Our Max PDU Receive Size:    16384<br>D: Their Max PDU Receive Size:  0<br>D: Presentation Contexts:<br>D:   Context ID:        1 (Proposed)<br>D:     Abstract Syntax: =FINDPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Proposed Transfer Syntax(es):<br>D:       =LittleEndianExplicit<br>D:       =BigEndianExplicit<br>D:       =LittleEndianImplicit<br>D:   Context ID:        3 (Proposed)<br>D:     Abstract Syntax: =MOVEPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Proposed Transfer Syntax(es):<br>D:       =LittleEndianExplicit<br>D:       =BigEndianExplicit<br>D:       =LittleEndianImplicit<br>D: Requested Extended Negotiation: none<br>D: Accepted Extended Negotiation:  none<br>D: Requested User Identity Negotiation: none<br>D: User Identity Negotiation Response:  none<br>D: ======================= END A-ASSOCIATE-RQ ======================<br>I: Requesting Association<br>D: setting network send timeout to 60 seconds<br>D: setting network receive timeout to 60 seconds<br>D: Constructing Associate RQ PDU<br>D: PDU Type: Associate Accept, PDU Length: 216 + 6 bytes PDU header<br>D:   02  00  00  00  00  d8  00  01  00  00  41  4e  59  2d  53  43<br>D:   50  20  20  20  20  20  20  20  20  20  4d  4f  56  45  53  43<br>D:   55  20  20  20  20  20  20  20  20  20  00  00  00  00  00  00<br>D:   00  00  00  00  00  00  00  00  00  00  00  00  00  00  00  00<br>D:   00  00  00  00  00  00  00  00  00  00  10  00  00  15  31  2e<br>D:   32  2e  38  34  30  2e  31  30  30  30  38  2e  33  2e  31  2e<br>D:   31  2e  31  21  00  00  19  01  00  00  00  40  00  00  11  31<br>D:   2e  32  2e  38  34  30  2e  31  30  30  30  38  2e  31  2e  32<br>D:   21  00  00  19  03  00  00  00  40  00  00  11  31  2e  32  2e<br>D:   38  34  30  2e  31  30  30  30  38  2e  31  2e  32  50  00  00<br>D:   3d  51  00  00  04  00  00  80  00  52  00  00  22  31  2e  32<br>D:   2e  38  32  36  2e  30  2e  31  2e  33  36  38  30  30  34  33<br>D:   2e  32  2e  31  33  35  2e  31  30  36  36  2e  31  30  31  55<br>D:   00  00  0b  31  2e  35  2e  30  2f  57  49  4e  33  32<br>D: Parsing an A-ASSOCIATE PDU<br>D: Association Parameters Negotiated:<br>D: ====================== BEGIN A-ASSOCIATE-AC =====================<br>D: Our Implementation Class UID:      1.2.276.0.7230010.3.0.3.6.6<br>D: Our Implementation Version Name:   OFFIS_DCMTK_366<br>D: Their Implementation Class UID:    1.2.826.0.1.3680043.2.135.1066.101<br>D: Their Implementation Version Name: 1.5.0/WIN32<br>D: Application Context Name:    1.2.840.10008.3.1.1.1<br>D: Calling Application Name:    MOVESCU<br>D: Called Application Name:     ANY-SCP<br>D: Responding Application Name: ANY-SCP<br>D: Our Max PDU Receive Size:    16384<br>D: Their Max PDU Receive Size:  32768<br>D: Presentation Contexts:<br>D:   Context ID:        1 (Accepted)<br>D:     Abstract Syntax: =FINDPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Accepted SCP/SCU Role: Default<br>D:     Accepted Transfer Syntax: =LittleEndianImplicit<br>D:   Context ID:        3 (Accepted)<br>D:     Abstract Syntax: =MOVEPatientRootQueryRetrieveInformationModel<br>D:     Proposed SCP/SCU Role: Default<br>D:     Accepted SCP/SCU Role: Default<br>D:     Accepted Transfer Syntax: =LittleEndianImplicit<br>D: Requested Extended Negotiation: none<br>D: Accepted Extended Negotiation:  none<br>D: Requested User Identity Negotiation: none<br>D: User Identity Negotiation Response:  none<br>D: ======================= END A-ASSOCIATE-AC ======================<br>I: Association Accepted (Max Send PDV: 32756)<br></code></pre></td></tr></table></figure>

<p>After that, the C-MOVE request is sent using the P-DATA PDU. It can be seen that the C-MOVE message format is similar to C-FIND.</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Sending</span> <span class="hljs-variable">Move</span> <span class="hljs-variable">Request</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">OUTGOING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">MOVE</span> <span class="hljs-variable">RQ</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Presentation</span> <span class="hljs-built_in">Context</span> <span class="hljs-variable">ID</span>       <span class="hljs-operator">:</span> <span class="hljs-number">3</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span>                    <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">MOVEPatientRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">present</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Priority</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">medium</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Move</span> <span class="hljs-variable">Destination</span>              <span class="hljs-operator">:</span> <span class="hljs-variable">DCMTK</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Request</span> <span class="hljs-variable">Identifiers</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Dicom</span><span class="hljs-operator">-</span><span class="hljs-variable">Data</span><span class="hljs-operator">-</span><span class="hljs-built_in">Set</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-type">#</span> <span class="hljs-variable">Used</span> <span class="hljs-variable">TransferSyntax</span><span class="hljs-operator">:</span> <span class="hljs-variable">Little</span> <span class="hljs-variable">Endian</span> <span class="hljs-variable">Explicit</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0008</span><span class="hljs-operator">,</span><span class="hljs-number">0052</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">CS</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">STUDY</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">QueryRetrieveLevel</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">(</span><span class="hljs-number">0010</span><span class="hljs-operator">,</span><span class="hljs-number">0020</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">LO</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Case1</span><span class="hljs-punctuation">]</span>                                  <span class="hljs-type">#</span>   <span class="hljs-number">6</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">PatientID</span><br></code></pre></td></tr></table></figure>

<p>After processing the C-MOVE request on the SCP side, a connection request is initiated to the SCU. This request contains a <code>SecondaryCaptureImageStorage</code> Presentation Context, which is also consistent with the C-MOVE connection request mentioned earlier. You can see that the called application name sent by the other party is the name specified in the <code>-aem</code> parameter.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span>: <br><span class="hljs-attribute">D</span>: Association Received: <span class="hljs-number">59</span><br><span class="hljs-attribute">D</span>: setting network send timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: setting network receive timeout to <span class="hljs-number">60</span> seconds<br><span class="hljs-attribute">D</span>: PDU Type: Associate Request, PDU Length: <span class="hljs-number">216</span> + <span class="hljs-number">6</span> bytes PDU header<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  d<span class="hljs-number">8</span>  <span class="hljs-number">00</span>  <span class="hljs-number">01</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">44</span>  <span class="hljs-number">43</span>  <span class="hljs-number">4</span>d  <span class="hljs-number">54</span>  <span class="hljs-number">4</span>b  <span class="hljs-number">20</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">43</span>  <span class="hljs-number">4</span>f  <span class="hljs-number">4</span>e  <span class="hljs-number">51</span>  <span class="hljs-number">55</span>  <span class="hljs-number">45</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">53</span>  <span class="hljs-number">54</span>  <span class="hljs-number">53</span>  <span class="hljs-number">52</span>  <span class="hljs-number">56</span>  <span class="hljs-number">31</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">20</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">10</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">15</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">20</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">36</span>  <span class="hljs-number">77</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">30</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">19</span>  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">34</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">37</span>  <span class="hljs-number">40</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">11</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e<br><span class="hljs-attribute">D</span>:   <span class="hljs-number">38</span>  <span class="hljs-number">34</span>  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">38</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">50</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">3</span>d  <span class="hljs-number">51</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">04</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">80</span>  <span class="hljs-number">00</span>  <span class="hljs-number">52</span>  <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">22</span>  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">38</span>  <span class="hljs-number">32</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">36</span>  <span class="hljs-number">38</span>  <span class="hljs-number">30</span>  <span class="hljs-number">30</span>  <span class="hljs-number">34</span>  <span class="hljs-number">33</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">2</span>e  <span class="hljs-number">32</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">33</span>  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">36</span>  <span class="hljs-number">36</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">31</span>  <span class="hljs-number">30</span>  <span class="hljs-number">31</span>  <span class="hljs-number">55</span><br><span class="hljs-attribute">D</span>:   <span class="hljs-number">00</span>  <span class="hljs-number">00</span>  <span class="hljs-number">0</span>b  <span class="hljs-number">31</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">35</span>  <span class="hljs-number">2</span>e  <span class="hljs-number">30</span>  <span class="hljs-number">2</span>f  <span class="hljs-number">57</span>  <span class="hljs-number">49</span>  <span class="hljs-number">4</span>e  <span class="hljs-number">33</span>  <span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Parsing an A-ASSOCIATE PDU<br><span class="hljs-attribute">I</span>: Sub-Association Received<br><span class="hljs-attribute">D</span>: Parameters:<br><span class="hljs-attribute">D</span>: ====================== BEGIN A-ASSOCIATE-RQ =====================<br><span class="hljs-attribute">D</span>: Our Implementation Class UID:      <span class="hljs-number">1.2.276.0</span>.<span class="hljs-number">7230010</span>.<span class="hljs-number">3.0.3.6</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">D</span>: Our Implementation Version Name:   OFFIS_DCMTK_<span class="hljs-number">366</span><br><span class="hljs-attribute">D</span>: Their Implementation Class UID:    <span class="hljs-number">1.2.826.0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3680043</span>.<span class="hljs-number">2</span>.<span class="hljs-number">135</span>.<span class="hljs-number">1066</span>.<span class="hljs-number">101</span><br><span class="hljs-attribute">D</span>: Their Implementation Version Name: <span class="hljs-number">1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/WIN<span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Application Context Name:    <span class="hljs-number">1.2.840.100</span><span class="hljs-number">08.3.1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Calling Application Name:    CONQUESTSRV<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Called Application Name:     DCMTK<br><span class="hljs-attribute">D</span>: Responding Application Name: <br><span class="hljs-attribute">D</span>: Our Max PDU Receive Size:    <span class="hljs-number">16384</span><br><span class="hljs-attribute">D</span>: Their Max PDU Receive Size:  <span class="hljs-number">32768</span><br><span class="hljs-attribute">D</span>: Presentation Contexts:<br><span class="hljs-attribute">D</span>:   Context ID:        <span class="hljs-number">119</span> (Proposed)<br><span class="hljs-attribute">D</span>:     Abstract Syntax: =SecondaryCaptureImageStorage<br><span class="hljs-attribute">D</span>:     Proposed SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Proposed Transfer Syntax(es):<br><span class="hljs-attribute">D</span>:       =LittleEndianImplicit<br><span class="hljs-attribute">D</span>: Requested Extended Negotiation: none<br><span class="hljs-attribute">D</span>: Accepted Extended Negotiation:  none<br><span class="hljs-attribute">D</span>: Requested User Identity Negotiation: none<br><span class="hljs-attribute">D</span>: User Identity Negotiation Response:  none<br><span class="hljs-attribute">D</span>: ======================= END A-ASSOCIATE-RQ ======================<br><span class="hljs-attribute">D</span>: Constructing Associate AC PDU<br><span class="hljs-attribute">I</span>: Sub-Association Acknowledged (Max Send PDV: <span class="hljs-number">32756</span>)<br><span class="hljs-attribute">D</span>: ====================== BEGIN A-ASSOCIATE-AC =====================<br><span class="hljs-attribute">D</span>: Our Implementation Class UID:      <span class="hljs-number">1.2.276.0</span>.<span class="hljs-number">7230010</span>.<span class="hljs-number">3.0.3.6</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">D</span>: Our Implementation Version Name:   OFFIS_DCMTK_<span class="hljs-number">366</span><br><span class="hljs-attribute">D</span>: Their Implementation Class UID:    <span class="hljs-number">1.2.826.0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3680043</span>.<span class="hljs-number">2</span>.<span class="hljs-number">135</span>.<span class="hljs-number">1066</span>.<span class="hljs-number">101</span><br><span class="hljs-attribute">D</span>: Their Implementation Version Name: <span class="hljs-number">1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/WIN<span class="hljs-number">32</span><br><span class="hljs-attribute">D</span>: Application Context Name:    <span class="hljs-number">1.2.840.100</span><span class="hljs-number">08.3.1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Calling Application Name:    CONQUESTSRV<span class="hljs-number">1</span><br><span class="hljs-attribute">D</span>: Called Application Name:     DCMTK<br><span class="hljs-attribute">D</span>: Responding Application Name: <br><span class="hljs-attribute">D</span>: Our Max PDU Receive Size:    <span class="hljs-number">16384</span><br><span class="hljs-attribute">D</span>: Their Max PDU Receive Size:  <span class="hljs-number">32768</span><br><span class="hljs-attribute">D</span>: Presentation Contexts:<br><span class="hljs-attribute">D</span>:   Context ID:        <span class="hljs-number">119</span> (Accepted)<br><span class="hljs-attribute">D</span>:     Abstract Syntax: =SecondaryCaptureImageStorage<br><span class="hljs-attribute">D</span>:     Proposed SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted SCP/SCU Role: Default<br><span class="hljs-attribute">D</span>:     Accepted Transfer Syntax: =LittleEndianImplicit<br><span class="hljs-attribute">D</span>: Requested Extended Negotiation: none<br><span class="hljs-attribute">D</span>: Accepted Extended Negotiation:  none<br><span class="hljs-attribute">D</span>: Requested User Identity Negotiation: none<br><span class="hljs-attribute">D</span>: User Identity Negotiation Response:  none<br><span class="hljs-attribute">D</span>: ======================= END A-ASSOCIATE-AC ======================<br><span class="hljs-attribute">D</span>: DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>After the reverse connection is established, the C-STORE request from the other party can be accepted and the transmission can begin.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">I:</span> Received Store Request<br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-STORE RQ<br><span class="hljs-symbol">D:</span> Presentation Context ID       : <span class="hljs-number">119</span><br><span class="hljs-symbol">D:</span> Message ID                    : <span class="hljs-number">3203</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : SecondaryCaptureImageStorage<br><span class="hljs-symbol">D:</span> Affected SOP Instance UID     : <span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">60.0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : present<br><span class="hljs-symbol">D:</span> Priority                      : medium<br><span class="hljs-symbol">D:</span> Move Originator AE Title      : MOVESCU<br><span class="hljs-symbol">D:</span> Move Originator ID            : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingValue (<span class="hljs-number">0028</span>,<span class="hljs-number">0120</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingRangeLimit (<span class="hljs-number">0028</span>,<span class="hljs-number">0121</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">W:</span> DICOM file already exists, overwriting: SC.<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">60.0</span><br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() Version <span class="hljs-keyword">of</span> MetaHeader <span class="hljs-built_in">is</span> ok: <span class="hljs-number">0</span>x0001<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPClassUID [<span class="hljs-number">1.2</span>.<span class="hljs-number">840.10008</span>.<span class="hljs-number">5.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">1.7</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPInstanceUID [<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">60.0</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use <span class="hljs-built_in">new</span> TransferSyntaxUID [Little Endian Implicit] <span class="hljs-keyword">on</span> writing following Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::validateMetaInfo() found <span class="hljs-number">7</span> Elements <span class="hljs-keyword">in</span> DcmMetaInfo <span class="hljs-comment">&#x27;metinf&#x27;</span><br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>After a C-STORE transfer is complete, a C-MOVE response is received, but since there are other transfers in progress, the <code>DIMSE Status</code> is Pending. Then there is the next C-STORE request and the corresponding transmission process and response.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">I:</span> Received Move Response <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-MOVE RSP<br><span class="hljs-symbol">D:</span> Message ID Being Responded <span class="hljs-keyword">To</span> : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : MOVEPatientRootQueryRetrieveInformationModel<br><span class="hljs-symbol">D:</span> Remaining Suboperations       : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Completed Suboperations       : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Failed Suboperations          : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Warning Suboperations         : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : none<br><span class="hljs-symbol">D:</span> DIMSE Status                  : <span class="hljs-number">0</span>xff00: Pending: <span class="hljs-keyword">Sub</span>-operations are continuing<br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">I:</span> Received Store Request<br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-STORE RQ<br><span class="hljs-symbol">D:</span> Presentation Context ID       : <span class="hljs-number">119</span><br><span class="hljs-symbol">D:</span> Message ID                    : <span class="hljs-number">3225</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : SecondaryCaptureImageStorage<br><span class="hljs-symbol">D:</span> Affected SOP Instance UID     : <span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">67.0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : present<br><span class="hljs-symbol">D:</span> Priority                      : medium<br><span class="hljs-symbol">D:</span> Move Originator AE Title      : MOVESCU<br><span class="hljs-symbol">D:</span> Move Originator ID            : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingValue (<span class="hljs-number">0028</span>,<span class="hljs-number">0120</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">D:</span> DcmItem::checkAndUpdateVR() setting undefined VR <span class="hljs-keyword">of</span> PixelPaddingRangeLimit (<span class="hljs-number">0028</span>,<span class="hljs-number">0121</span>) <span class="hljs-keyword">to</span> <span class="hljs-comment">&#x27;US&#x27; because PixelRepresentation (0028,0103) has a value that is different from 1</span><br><span class="hljs-symbol">W:</span> DICOM file already exists, overwriting: SC.<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">67.0</span><br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() Version <span class="hljs-keyword">of</span> MetaHeader <span class="hljs-built_in">is</span> ok: <span class="hljs-number">0</span>x0001<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPClassUID [<span class="hljs-number">1.2</span>.<span class="hljs-number">840.10008</span>.<span class="hljs-number">5.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">1.7</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use SOPInstanceUID [<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">4.1</span>.<span class="hljs-number">5962.99</span>.<span class="hljs-number">1.2280943358</span>.<span class="hljs-number">716200484.1363785608958</span>.<span class="hljs-number">67.0</span>] <span class="hljs-keyword">from</span> Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::checkMetaHeaderValue() use <span class="hljs-built_in">new</span> TransferSyntaxUID [Little Endian Implicit] <span class="hljs-keyword">on</span> writing following Dataset<br><span class="hljs-symbol">D:</span> DcmFileFormat::validateMetaInfo() found <span class="hljs-number">7</span> Elements <span class="hljs-keyword">in</span> DcmMetaInfo <span class="hljs-comment">&#x27;metinf&#x27;</span><br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br><span class="hljs-symbol">I:</span> Received Move Response <span class="hljs-number">2</span><br><span class="hljs-symbol">D:</span> ===================== INCOMING DIMSE MESSAGE ====================<br><span class="hljs-symbol">D:</span> Message Type                  : C-MOVE RSP<br><span class="hljs-symbol">D:</span> Message ID Being Responded <span class="hljs-keyword">To</span> : <span class="hljs-number">1</span><br><span class="hljs-symbol">D:</span> Affected SOP <span class="hljs-keyword">Class</span> UID        : MOVEPatientRootQueryRetrieveInformationModel<br><span class="hljs-symbol">D:</span> Remaining Suboperations       : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Completed Suboperations       : <span class="hljs-number">2</span><br><span class="hljs-symbol">D:</span> Failed Suboperations          : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Warning Suboperations         : <span class="hljs-number">0</span><br><span class="hljs-symbol">D:</span> Data <span class="hljs-keyword">Set</span>                      : none<br><span class="hljs-symbol">D:</span> DIMSE Status                  : <span class="hljs-number">0</span>xff00: Pending: <span class="hljs-keyword">Sub</span>-operations are continuing<br><span class="hljs-symbol">D:</span> ======================= <span class="hljs-keyword">END</span> DIMSE MESSAGE =======================<br><span class="hljs-symbol">D:</span> DcmDataset::read() TransferSyntax=<span class="hljs-string">&quot;Little Endian Implicit&quot;</span><br></code></pre></td></tr></table></figure>

<p>After all C-STORE requests are completed, the server will send a successful C-STORE response:</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Received</span> <span class="hljs-variable">Final</span> <span class="hljs-variable">Move</span> <span class="hljs-variable">Response</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=====================</span> <span class="hljs-variable">INCOMING</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">====================</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">Type</span>                  <span class="hljs-operator">:</span> <span class="hljs-built_in">C</span><span class="hljs-operator">-</span><span class="hljs-variable">MOVE</span> <span class="hljs-variable">RSP</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Message</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Being</span> <span class="hljs-variable">Responded</span> <span class="hljs-variable">To</span> <span class="hljs-operator">:</span> <span class="hljs-number">1</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Affected</span> <span class="hljs-variable">SOP</span> <span class="hljs-variable">Class</span> <span class="hljs-variable">UID</span>        <span class="hljs-operator">:</span> <span class="hljs-variable">MOVEPatientRootQueryRetrieveInformationModel</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Remaining</span> <span class="hljs-variable">Suboperations</span>       <span class="hljs-operator">:</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Completed</span> <span class="hljs-variable">Suboperations</span>       <span class="hljs-operator">:</span> <span class="hljs-number">2</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Failed</span> <span class="hljs-variable">Suboperations</span>          <span class="hljs-operator">:</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Warning</span> <span class="hljs-variable">Suboperations</span>         <span class="hljs-operator">:</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">Data</span> <span class="hljs-built_in">Set</span>                      <span class="hljs-operator">:</span> <span class="hljs-variable">none</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">Status</span>                  <span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000</span><span class="hljs-operator">:</span> <span class="hljs-built_in">Success</span><span class="hljs-operator">:</span> <span class="hljs-variable">Sub</span><span class="hljs-operator">-</span><span class="hljs-variable">operations</span> <span class="hljs-variable">complete</span> <span class="hljs-operator">-</span> <span class="hljs-variable">No</span> <span class="hljs-variable">failures</span> <span class="hljs-variable">or</span> <span class="hljs-variable">warnings</span><br><span class="hljs-built_in">D</span><span class="hljs-operator">:</span> <span class="hljs-operator">=======================</span> <span class="hljs-variable">END</span> <span class="hljs-variable">DIMSE</span> <span class="hljs-variable">MESSAGE</span> <span class="hljs-operator">=======================</span><br><span class="hljs-built_in">I</span><span class="hljs-operator">:</span> <span class="hljs-variable">Releasing</span> <span class="hljs-built_in">Association</span><br></code></pre></td></tr></table></figure>

<p>At this point, the C-MOVE transfer is completed.</p>
<p>Image file transmission is TCP transmission with PDV=4096Bytes:</p>
<img src="image-20211013195720471.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013195720471" style="zoom:50%;" />

<p>The files downloaded to the local can be opened for viewing and processing, such as using the toolkit in DCMTK or other third-party software</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ getscu -k 08,52=STUDY -k StudyInstanceUID=1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.61.0  192.168.31.156 5678  <br>➜  ~ ls -lt<br>total 148576<br>-rw-r--r--    1 zzy   staff  31354908 10  8 22:46 SC.1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.67.0<br>-rw-r--r--    1 zzy   staff   4367746 10  8 22:45 SC.1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.60.0<br></code></pre></td></tr></table></figure>

<h3 id="C-GET"><a href="#C-GET" class="headerlink" title="C-GET"></a>C-GET</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">➜  ~ sudo getscu -v -k 08,52=STUDY -k StudyInstanceUID=1.3.6.1.4.1.5962.99.1.2280943358.716200484.1363785608958.61.0  192.168.31.156 5678  <br>I: Requesting Association<br>I: Association Accepted (Max Send PDV: 32756)<br>I: Sending C-GET Request (MsgID 1)<br>I: Received C-STORE Request (MsgID 4261)<br>I: Sending C-STORE Response (Success)<br>I: Received C-GET Response (Pending)<br>I: Received C-STORE Request (MsgID 4281)<br>I: Sending C-STORE Response (Success)<br>I: Received C-GET Response (Pending)<br>I: Received C-GET Response (Success)<br>I: Final status report from last C-GET message:<br>I:   Number of Remaining Suboperations : 0<br>I:   Number of Completed Suboperations : 2<br>I:   Number of Failed Suboperations    : 0<br>I:   Number of Warning Suboperations   : 0<br>I: Releasing Association<br></code></pre></td></tr></table></figure>

<p>The process of C-GET is simpler than C-MOVE. It sends all Presentation Contexts like C-STORE when establishing a connection.</p>
<img src="image-20211013234755122.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013234755122" style="zoom:50%;" />

<p>The following is the message content of C-GET, which is similar to the structure of C-FIND:</p>
<img src="image-20211013195701896.png" srcset="/StaticBlog/en/img/loading.gif" lazyload alt="image-20211013195701896" style="zoom:50%;" />

<p>After sending the C-GET message, the other party will send a C-STORE message to start the transmission.</p>
<h3 id="three-Results-and-discussion"><a href="#three-Results-and-discussion" class="headerlink" title="three. Results and discussion"></a>three. Results and discussion</h3><p>In this project, based on the DICOM standard, I have completed a mini-PACS system that meets 11 protocols of the DICOM standard by selecting the open source DCMTK toolkit that implements the DICOM standard as Modality and View Station, and CONQUEST as the Server. In the process, through the analysis of the DICOM standard reading and the packet capture software, the structure of the DICOM image transmission protocol is understood, and the design of its TCP -&gt; ULP -&gt; PDU -&gt; DATA is understood. Based on the above understanding, the detailed process of transmission can be clearly understood, that is, the connection is controlled through Associate PDU and Release PDU, and data is transmitted through P-DATA. The data contains messages that are strictly defined in the format of DICOM3.0, so that the relevant interfaces are implemented. The transmission function specified by DICOM can be realized between the client and the server.</p>
<h3 id="quote"><a href="#quote" class="headerlink" title="quote"></a>quote</h3><ol>
<li>pydicom documentation: <a target="_blank" rel="noopener" href="https://pydicom.github.io/pynetdicom/stable/user/presentation.html">https://pydicom.github.io/pynetdicom/stable/user/presentation.html</a></li>
<li>DICOM Standard 3.0: <a target="_blank" rel="noopener" href="http://dicom.nema.org/medical/dicom/current/output/chtml/">http://dicom.nema.org/medical/dicom/current/output/chtml/</a></li>
<li>DICOM communication process: <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6f178fc98a04">https://www.jianshu.com/p/6f178fc98a04</a></li>
<li>DCMTK：<a target="_blank" rel="noopener" href="https://support.dcmtk.org/docs">https://support.dcmtk.org/docs</a></li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/StaticBlog/en/tags/DICOM/">DICOM</a>
                    
                      <a class="hover-with-bg" href="/StaticBlog/en/tags/Biomedical-Engineering/">Biomedical Engineering</a>
                    
                      <a class="hover-with-bg" href="/StaticBlog/en/tags/Biomedical-Imaging/">Biomedical Imaging</a>
                    
                      <a class="hover-with-bg" href="/StaticBlog/en/tags/Network/">Network</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    This article uses <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" rel="nofollow noopener noopener">CC BY-SA 4.0 License</a>. You may need to give appropriate credit, provide a link to the license, and indicate if changes were made when referencing this article.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/StaticBlog/en/2022/04/24/dmzjReader/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Save My Kindle: Make EPUBs with JS</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/StaticBlog/en/2021/10/09/hexo-i18n-by-article-translator/">
                        <span class="hidden-mobile">Markdown Auto Translation</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-1"></div>
     
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrow-up-alt" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a>Made with </a> <i class="iconfont icon-love"></i> <a> by </a> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo </span></a> and <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>  Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/StaticBlog/en/js/events.js" ></script>
<script  src="/StaticBlog/en/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/StaticBlog/en/js/local-search.js" ></script>



  
    <script  src="/StaticBlog/en/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/StaticBlog/en/js/boot.js" ></script>


</body>
</html>
